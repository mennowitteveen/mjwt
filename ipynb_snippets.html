<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="This notebook &amp; webpage (depending on how you’re access it) contains a quick reference for python code to do various things. See the legend on the right to jump to a section.">

<title>mjwt - ipynb_snippets</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="mjwt - ipynb_snippets">
<meta property="og:description" content="This notebook &amp; webpage (depending on how you’re access it) contains a quick reference for python code to do various things. See the legend on the right to jump to a section.">
<meta property="og:image" content="https://mennowitteveen.github.io/mjwt/ipynb_snippets_files/figure-html/cell-17-output-1.png">
<meta property="og:site-name" content="mjwt">
<meta property="og:image:height" content="428">
<meta property="og:image:width" content="825">
<meta name="twitter:title" content="mjwt - ipynb_snippets">
<meta name="twitter:description" content="This notebook &amp; webpage (depending on how you’re access it) contains a quick reference for python code to do various things. See the legend on the right to jump to a section.">
<meta name="twitter:image" content="https://mennowitteveen.github.io/mjwt/ipynb_snippets_files/figure-html/cell-17-output-1.png">
<meta name="twitter:image-height" content="428">
<meta name="twitter:image-width" content="825">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">mjwt</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ipynb_snippets.html">ipynb_snippets</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">mjwt</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">utils</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cmd_snippets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">cmd_snippets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ipynb_snippets.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">ipynb_snippets</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#some-brief-notes" id="toc-some-brief-notes" class="nav-link active" data-scroll-target="#some-brief-notes">Some brief notes:</a></li>
  <li><a href="#imports" id="toc-imports" class="nav-link" data-scroll-target="#imports">Imports</a></li>
  <li><a href="#data-viz-exporation" id="toc-data-viz-exporation" class="nav-link" data-scroll-target="#data-viz-exporation">Data Viz &amp; Exporation</a>
  <ul class="collapse">
  <li><a href="#matplotlib-tricks" id="toc-matplotlib-tricks" class="nav-link" data-scroll-target="#matplotlib-tricks">Matplotlib tricks</a></li>
  <li><a href="#pandas" id="toc-pandas" class="nav-link" data-scroll-target="#pandas">Pandas</a></li>
  <li><a href="#viz-config-stuff-for-pdsnsplt" id="toc-viz-config-stuff-for-pdsnsplt" class="nav-link" data-scroll-target="#viz-config-stuff-for-pdsnsplt">Viz config stuff for pd+sns+plt</a></li>
  <li><a href="#manhattan-plots" id="toc-manhattan-plots" class="nav-link" data-scroll-target="#manhattan-plots">Manhattan Plots</a></li>
  </ul></li>
  <li><a href="#data-processing-trickery-pandasnumpy" id="toc-data-processing-trickery-pandasnumpy" class="nav-link" data-scroll-target="#data-processing-trickery-pandasnumpy">Data Processing Trickery (Pandas&amp;Numpy)</a>
  <ul class="collapse">
  <li><a href="#numpy" id="toc-numpy" class="nav-link" data-scroll-target="#numpy">Numpy</a></li>
  <li><a href="#pandas-1" id="toc-pandas-1" class="nav-link" data-scroll-target="#pandas-1">Pandas</a></li>
  </ul></li>
  <li><a href="#ml-recipes" id="toc-ml-recipes" class="nav-link" data-scroll-target="#ml-recipes">ML Recipes</a>
  <ul class="collapse">
  <li><a href="#pytorch-101" id="toc-pytorch-101" class="nav-link" data-scroll-target="#pytorch-101">Pytorch 101</a></li>
  <li><a href="#keras-snippet" id="toc-keras-snippet" class="nav-link" data-scroll-target="#keras-snippet">Keras Snippet</a></li>
  <li><a href="#gaussian-processes" id="toc-gaussian-processes" class="nav-link" data-scroll-target="#gaussian-processes">Gaussian Processes</a></li>
  <li><a href="#recipe-resources" id="toc-recipe-resources" class="nav-link" data-scroll-target="#recipe-resources">Recipe Resources</a></li>
  </ul></li>
  <li><a href="#threading-multiprocessing-sys-ops" id="toc-threading-multiprocessing-sys-ops" class="nav-link" data-scroll-target="#threading-multiprocessing-sys-ops">Threading, Multiprocessing &amp; Sys-Ops</a>
  <ul class="collapse">
  <li><a href="#ram-usage" id="toc-ram-usage" class="nav-link" data-scroll-target="#ram-usage">RAM usage:</a></li>
  <li><a href="#vanilla" id="toc-vanilla" class="nav-link" data-scroll-target="#vanilla">Vanilla (?)</a></li>
  <li><a href="#submitit-pipeline" id="toc-submitit-pipeline" class="nav-link" data-scroll-target="#submitit-pipeline">Submitit pipeline</a>
  <ul class="collapse">
  <li><a href="#basic-setup" id="toc-basic-setup" class="nav-link" data-scroll-target="#basic-setup">Basic setup</a></li>
  <li><a href="#parameter-grid" id="toc-parameter-grid" class="nav-link" data-scroll-target="#parameter-grid">Parameter Grid</a></li>
  <li><a href="#job-processing" id="toc-job-processing" class="nav-link" data-scroll-target="#job-processing">Job processing</a></li>
  </ul></li>
  <li><a href="#profling" id="toc-profling" class="nav-link" data-scroll-target="#profling">Profling</a></li>
  <li><a href="#timing-experiments" id="toc-timing-experiments" class="nav-link" data-scroll-target="#timing-experiments">Timing Experiments:</a></li>
  </ul></li>
  <li><a href="#schedulers" id="toc-schedulers" class="nav-link" data-scroll-target="#schedulers">Schedulers</a>
  <ul class="collapse">
  <li><a href="#slurm-submitit-tricks" id="toc-slurm-submitit-tricks" class="nav-link" data-scroll-target="#slurm-submitit-tricks">Slurm &amp; Submitit Tricks</a></li>
  </ul></li>
  <li><a href="#jupyter-things" id="toc-jupyter-things" class="nav-link" data-scroll-target="#jupyter-things">Jupyter things</a>
  <ul class="collapse">
  <li><a href="#javascript-html-formatting" id="toc-javascript-html-formatting" class="nav-link" data-scroll-target="#javascript-html-formatting">Javascript, HTML, formatting</a></li>
  <li><a href="#create-your-own-magic" id="toc-create-your-own-magic" class="nav-link" data-scroll-target="#create-your-own-magic">Create your own magic!</a></li>
  </ul></li>
  <li><a href="#development" id="toc-development" class="nav-link" data-scroll-target="#development">Development</a>
  <ul class="collapse">
  <li><a href="#tricks" id="toc-tricks" class="nav-link" data-scroll-target="#tricks">Tricks</a></li>
  <li><a href="#under-the-hoodys" id="toc-under-the-hoodys" class="nav-link" data-scroll-target="#under-the-hoodys">Under the hoodys:</a></li>
  <li><a href="#argparse" id="toc-argparse" class="nav-link" data-scroll-target="#argparse">argparse</a></li>
  <li><a href="#bash" id="toc-bash" class="nav-link" data-scroll-target="#bash">Bash</a></li>
  <li><a href="#decoration" id="toc-decoration" class="nav-link" data-scroll-target="#decoration">Decoration</a></li>
  <li><a href="#package-creation-stuff" id="toc-package-creation-stuff" class="nav-link" data-scroll-target="#package-creation-stuff">Package creation stuff</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mennowitteveen/mjwt/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ipynb_snippets</h1>
</div>

<div>
  <div class="description">
    This notebook &amp; webpage (depending on how you’re access it) contains a quick reference for python code to do various things. See the legend on the right to jump to a section.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>The notebook book contains yada yada yada. It is the philosophy to have all the snippets in the notebook work, with needed data being present in mjwt repo. In some cases this might not possible.</p>
<section id="some-brief-notes" class="level1">
<h1>Some brief notes:</h1>
<ul>
<li><a href="https://hamel.dev/notes/linux/bash_scripting.html">Hamel’s blog for inspiration</a></li>
<li>some person’s homepage https://www.mm218.dev/</li>
</ul>
<p><b> Todo dump: </b></p>
<ul>
<li>pd.set_option(‘display.float_format’, lambda x: ‘%.3f’ % x)</li>
<li>vars(obj) method decorator ..
<ul>
<li>have everythign present in e.g.&nbsp;.fit() without having to this=self.this; that=self.that etc</li>
<li>have same thing for the output state/for iters</li>
</ul></li>
<li>ramgb() function in tools?</li>
<li>make ~/cmd commands avail in mjwt?</li>
</ul>
<p>Oke this is a bunch of test text</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">title</span><span class="op">=</span><span class="st">'ipynb_snips'</span> <span class="co">// this is usefull for renaming tab like in jupyter</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/javascript">
document.title='ipynb_snips' // this is usefull for renaming tab like in jupyter

</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the req. file for docker</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip freeze <span class="op">&gt;</span> <span class="op">/</span>home<span class="op">/</span>jovyan<span class="op">/</span>proj<span class="op">/</span>docker<span class="op">/</span>jupyter<span class="op">-</span>base<span class="op">-</span>ds<span class="op">/</span>requirements.txt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>git config <span class="op">--</span><span class="kw">global</span> user.email <span class="st">""</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>git config <span class="op">--</span><span class="kw">global</span> user.name  <span class="st">"Menno Witteveen"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>git <span class="op">-</span>C <span class="op">/</span>home<span class="op">/</span>jovyan<span class="op">/</span>proj<span class="op">/</span>docker<span class="op">/</span>jupyter<span class="op">-</span>compbio<span class="op">-</span>ds<span class="op">/</span> add requirements.txt</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># !git -C /home/jovyan/proj/docker/jupyter-base-ds/ status</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>git <span class="op">-</span>C <span class="op">/</span>home<span class="op">/</span>jovyan<span class="op">/</span>proj<span class="op">/</span>docker<span class="op">/</span>jupyter<span class="op">-</span>compbio<span class="op">-</span>ds<span class="op">/</span> commit <span class="op">-</span>m <span class="st">"update req.txt with line_profiler"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 'ff'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="imports" class="level1">
<h1>Imports</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">########################################################</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Base Imports:</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sys Imports:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, sys, os</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard Imports:</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy <span class="im">as</span> sp</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats, linalg</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#########################################################</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">## Experiment Specific Imports</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistics Imports:</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect, glob, re, contextlib, pickle, functools, warnings <span class="co">#,submitit #pyreadr</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> suppress<span class="op">;</span> <span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor, ProcessPoolExecutor</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mjwt.utils <span class="im">import</span> jobinfo, corr, implot, sizegb, psrc, beep, Timer, Struct <span class="im">as</span> mStruct</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ML Imports:</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score, roc_auc_score</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, ParameterGrid</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> BayesianRidge <span class="co"># Just to have model around</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> pearsonr, spearmanr</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Genomics Imports:</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pysnptools <span class="im">as</span> pst</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pysnptools.snpreader <span class="im">import</span> Bed, Pheno, SnpHdf5, SnpData</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pysnptools.pstreader <span class="im">import</span> PstData, PstHdf5, PstReader</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lambdapred.utils <span class="im">import</span> load_bimfam</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">########################################################</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">## Configuration &amp; Initialisation</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Display Configuration:</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> set_matplotlib_formats, display, HTML, Javascript</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">5</span>]</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'max_colwidth'</span>, <span class="dv">200</span>) </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.set_option('display.max_colwidth', None) # No pd trunkation (radical)</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co"># display(HTML("&lt;style&gt;.container { width:75% !important; }&lt;/style&gt;"))</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.reset_option('all')</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializations &amp; Extensions:</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>timer <span class="op">=</span> Timer()<span class="op">;</span> toc <span class="op">=</span> timer.toc<span class="op">;</span> tic <span class="op">=</span> timer.tic<span class="op">;</span> tic(<span class="st">''</span>)<span class="op">;</span> log<span class="op">=</span>np.log10 <span class="co">#p.s. not easy to make it tic;time.sleep(2);toc</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>notebook <span class="op">=</span> <span class="va">False</span>  <span class="cf">if</span> <span class="st">'__file__'</span> <span class="kw">in</span> <span class="bu">locals</span>() <span class="cf">else</span> <span class="va">True</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> contextlib.suppress(<span class="pp">Exception</span>): os.environ[<span class="st">"OMP_NUM_THREADS"</span>] <span class="op">=</span> <span class="bu">str</span>(<span class="bu">int</span>(os.environ[<span class="st">'SLURM_JOB_CPUS_PER_NODE'</span>]) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> contextlib.suppress(<span class="pp">BaseException</span>): <span class="co"># non-essential import for`b development.</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    get_ipython().run_line_magic(<span class="st">'load_ext'</span>, <span class="st">'line_profiler'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install torch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tqdm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-viz-exporation" class="level1">
<h1>Data Viz &amp; Exporation</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylab <span class="im">import</span> <span class="op">*</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi, <span class="dv">400</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.sin(x<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>subplots_adjust(hspace<span class="op">=</span><span class="fl">0.000</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>number_of_subplots<span class="op">=</span><span class="dv">3</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,v <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">range</span>(number_of_subplots)):</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> v<span class="op">+</span><span class="dv">1</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> subplot(number_of_subplots,<span class="dv">1</span>,v)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    ax1.plot(x,y)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Approaches to load data (quickly):</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Some wine:</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> load_wine</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>wine_dt <span class="op">=</span> load_wine()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>wine_df <span class="op">=</span> pd.DataFrame(wine_dt[<span class="st">'data'</span>],columns<span class="op">=</span>wine_dt[<span class="st">'feature_names'</span>])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># display(wine_df.sample(3))</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting wine as general df</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> wine_df</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">6</span>,<span class="dv">5</span>])</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Ce = sp.cov(df.values.T)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> df.corr().values</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>plt.imshow(C,aspect<span class="op">=</span><span class="st">'auto'</span>,interpolation<span class="op">=</span><span class="st">'none'</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>plt.xticks(sp.arange(<span class="bu">len</span>(df.columns)),df.columns,rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>plt.yticks(sp.arange(<span class="bu">len</span>(df.columns)),df.columns,rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_84492/1749909219.py:15: DeprecationWarning: scipy.arange is deprecated and will be removed in SciPy 2.0.0, use numpy.arange instead
  plt.xticks(sp.arange(len(df.columns)),df.columns,rotation=90)
/tmp/ipykernel_84492/1749909219.py:16: DeprecationWarning: scipy.arange is deprecated and will be removed in SciPy 2.0.0, use numpy.arange instead
  plt.yticks(sp.arange(len(df.columns)),df.columns,rotation=0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.colorbar.Colorbar&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-20-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the plt.figure is unfortunately needed if one needs to spec. figsize</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">9</span>))<span class="op">;</span> sns.heatmap(df.corr(), square<span class="op">=</span><span class="va">True</span>, annot<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-21-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df.hist(bins<span class="op">=</span><span class="dv">30</span>, figsize<span class="op">=</span>(<span class="dv">30</span>,<span class="dv">6</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="matplotlib-tricks" class="level2">
<h2 class="anchored" data-anchor-id="matplotlib-tricks">Matplotlib tricks</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use this to modifier your axis to your hearts contend:</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>,<span class="dv">10</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>x1,x2,y1,y2 <span class="op">=</span> plt.axis()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>plt.axis((x1,x2,<span class="dv">25</span>,<span class="dv">250</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0.0, 10.0, 25.0, 250.0)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Hairy fat-tailed distribution?: Use a linspace to set the buckets of a histogram nicely:</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span><span class="op">**</span><span class="dv">5</span><span class="op">;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>stds <span class="op">=</span> np.sqrt(<span class="dv">1</span><span class="op">/</span>np.random.rand(n)<span class="op">*</span><span class="dv">400</span>)<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>ws <span class="op">=</span> pd.DataFrame(np.random.randn(n)<span class="op">*</span>stds) <span class="co"># Rather weird fat-tailed weight distribution:</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ws.hist(bins<span class="op">=</span>np.linspace(<span class="op">-</span><span class="dv">200</span>,<span class="dv">200</span>,<span class="dv">200</span>), figsize<span class="op">=</span>[<span class="dv">10</span>,<span class="dv">3</span>])<span class="op">;</span> <span class="co"># &lt;-- without the bins argument this is a mess</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="pandas" class="level2">
<h2 class="anchored" data-anchor-id="pandas">Pandas</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load coef_df</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>coef_df <span class="op">=</span> pd.read_hdf(<span class="st">'coef_df.h5'</span>,<span class="st">'coef_df'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>coef_df.plot.scatter(x<span class="op">=</span><span class="dv">0</span>,y<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: xlabel='ga_totdays', ylabel='mat_age'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-36-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>coef_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ga_totdays</th>
<th data-quarto-table-cell-role="th">mat_age</th>
<th data-quarto-table-cell-role="th">mat_bmi</th>
<th data-quarto-table-cell-role="th">mpop_white</th>
<th data-quarto-table-cell-role="th">is_twin</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>1000.000000</td>
<td>1000.000000</td>
<td>1000.000000</td>
<td>1000.000000</td>
<td>1000.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>-0.288608</td>
<td>-0.134522</td>
<td>-0.238682</td>
<td>-0.336548</td>
<td>0.317581</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>0.061273</td>
<td>0.053639</td>
<td>0.052149</td>
<td>0.069799</td>
<td>0.064057</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>-0.475273</td>
<td>-0.305157</td>
<td>-0.385548</td>
<td>-0.557403</td>
<td>0.012321</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>-0.319592</td>
<td>-0.168062</td>
<td>-0.275030</td>
<td>-0.381171</td>
<td>0.284586</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>-0.279579</td>
<td>-0.140471</td>
<td>-0.240565</td>
<td>-0.343076</td>
<td>0.322209</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>-0.250055</td>
<td>-0.102844</td>
<td>-0.205305</td>
<td>-0.298686</td>
<td>0.355801</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>-0.118547</td>
<td>-0.000000</td>
<td>-0.000000</td>
<td>-0.000000</td>
<td>0.544112</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ?sns.pairplot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plt.figure()<span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>coef_df.plot.hist(alpha<span class="op">=</span><span class="fl">0.8</span>, bins<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1000x500 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-40-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For scattermatrix plot stuff</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>sns.pairplot(coef_df, plot_kws<span class="op">=</span>{<span class="st">"s"</span>: <span class="fl">1.0</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ipynb_snippets_files/figure-html/674d591e-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">image.png</figcaption>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>coef_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ga_totdays</th>
<th data-quarto-table-cell-role="th">mat_age</th>
<th data-quarto-table-cell-role="th">mat_bmi</th>
<th data-quarto-table-cell-role="th">mpop_white</th>
<th data-quarto-table-cell-role="th">is_twin</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.392195</td>
<td>-0.148588</td>
<td>-0.314482</td>
<td>-0.387349</td>
<td>0.317503</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.386727</td>
<td>-0.189583</td>
<td>-0.313807</td>
<td>-0.400882</td>
<td>0.378390</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.290056</td>
<td>-0.160036</td>
<td>-0.225576</td>
<td>-0.349331</td>
<td>0.240991</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.238261</td>
<td>-0.084640</td>
<td>-0.230761</td>
<td>-0.321250</td>
<td>0.225304</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.252113</td>
<td>-0.056818</td>
<td>-0.176889</td>
<td>-0.270960</td>
<td>0.355325</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">995</td>
<td>-0.356478</td>
<td>-0.129357</td>
<td>-0.299575</td>
<td>-0.343666</td>
<td>0.278307</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">996</td>
<td>-0.272725</td>
<td>-0.133474</td>
<td>-0.177013</td>
<td>-0.276120</td>
<td>0.290608</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">997</td>
<td>-0.245847</td>
<td>-0.077554</td>
<td>-0.235886</td>
<td>-0.437620</td>
<td>0.246134</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">998</td>
<td>-0.281898</td>
<td>-0.164914</td>
<td>-0.212031</td>
<td>-0.351553</td>
<td>0.304425</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">999</td>
<td>-0.274264</td>
<td>-0.115117</td>
<td>-0.199899</td>
<td>-0.205464</td>
<td>0.253323</td>
</tr>
</tbody>
</table>

<p>1000 rows × 5 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># coef_df.plot.scatter(x=0,y=1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is almost the way.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>coef_df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: sns.distplot(x, hist <span class="op">=</span> <span class="va">False</span>, kde <span class="op">=</span> <span class="va">True</span>, kde_kws <span class="op">=</span> {<span class="st">'shade'</span>: <span class="va">True</span>, <span class="st">'linewidth'</span>: <span class="dv">3</span>, <span class="st">'label'</span> : x.name}))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1235/925458556.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `kdeplot` (an axes-level function for kernel density plots).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  coef_df.apply(lambda x: sns.distplot(x, hist = False, kde = True, kde_kws = {'shade': True, 'linewidth': 3, 'label' : x.name}));
/opt/conda/lib/python3.11/site-packages/seaborn/distributions.py:2511: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  kdeplot(**{axis: a}, ax=ax, color=kde_color, **kde_kws)
/tmp/ipykernel_1235/925458556.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `kdeplot` (an axes-level function for kernel density plots).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  coef_df.apply(lambda x: sns.distplot(x, hist = False, kde = True, kde_kws = {'shade': True, 'linewidth': 3, 'label' : x.name}));
/opt/conda/lib/python3.11/site-packages/seaborn/distributions.py:2511: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  kdeplot(**{axis: a}, ax=ax, color=kde_color, **kde_kws)
/tmp/ipykernel_1235/925458556.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `kdeplot` (an axes-level function for kernel density plots).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  coef_df.apply(lambda x: sns.distplot(x, hist = False, kde = True, kde_kws = {'shade': True, 'linewidth': 3, 'label' : x.name}));
/opt/conda/lib/python3.11/site-packages/seaborn/distributions.py:2511: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  kdeplot(**{axis: a}, ax=ax, color=kde_color, **kde_kws)
/tmp/ipykernel_1235/925458556.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `kdeplot` (an axes-level function for kernel density plots).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  coef_df.apply(lambda x: sns.distplot(x, hist = False, kde = True, kde_kws = {'shade': True, 'linewidth': 3, 'label' : x.name}));
/opt/conda/lib/python3.11/site-packages/seaborn/distributions.py:2511: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  kdeplot(**{axis: a}, ax=ax, color=kde_color, **kde_kws)
/tmp/ipykernel_1235/925458556.py:2: UserWarning: 

`distplot` is a deprecated function and will be removed in seaborn v0.14.0.

Please adapt your code to use either `displot` (a figure-level function with
similar flexibility) or `kdeplot` (an axes-level function for kernel density plots).

For a guide to updating your code to use the new functions, please see
https://gist.github.com/mwaskom/de44147ed2974457ad6372750bbe5751

  coef_df.apply(lambda x: sns.distplot(x, hist = False, kde = True, kde_kws = {'shade': True, 'linewidth': 3, 'label' : x.name}));
/opt/conda/lib/python3.11/site-packages/seaborn/distributions.py:2511: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  kdeplot(**{axis: a}, ax=ax, color=kde_color, **kde_kws)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-47-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is almost the way.</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>coef_df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: sns.kdeplot(x, kde_kws <span class="op">=</span> {<span class="st">'shade'</span>: <span class="va">True</span>, <span class="st">'linewidth'</span>: <span class="dv">3</span>, <span class="st">'label'</span> : x.name}))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>AttributeError: Line2D.set() got an unexpected keyword argument 'kde_kws'</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-48-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>coef_df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: sns.kdeplot(x, <span class="op">**</span>{<span class="st">'fill'</span>: <span class="va">True</span>, <span class="st">'linewidth'</span>: <span class="dv">3</span>, <span class="st">'label'</span> : x.name}))<span class="op">;</span> plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.legend.Legend&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-49-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want this without warnings, you need to go and update it ("distplot" is getting removed).</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    coef_df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: sns.distplot(x, hist <span class="op">=</span> <span class="va">True</span>, kde <span class="op">=</span> <span class="va">True</span>, hist_kws<span class="op">=</span>{<span class="st">"alpha"</span>:<span class="fl">0.3</span>, <span class="st">"linewidth"</span>: <span class="dv">3</span>}, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                                         kde_kws <span class="op">=</span> {<span class="st">'shade'</span>: <span class="va">False</span>, <span class="st">'linewidth'</span>: <span class="dv">3</span>, <span class="st">'label'</span> : x.name, <span class="st">'alpha'</span>:<span class="fl">0.99</span>}))<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-50-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Iris data:</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>iris <span class="op">=</span> sns.load_dataset(<span class="st">"iris"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vanilla</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>iris.plot.scatter(x<span class="op">=</span><span class="st">'sepal_length'</span>,y<span class="op">=</span><span class="st">'petal_width'</span>,c<span class="op">=</span><span class="st">'petal_length'</span>,cmap<span class="op">=</span><span class="st">'bwr'</span>, figsize<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">1</span>),ax<span class="op">=</span>plt.subplot(<span class="dv">111</span>))<span class="op">;</span> plt.show()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>iris.plot.scatter(x<span class="op">=</span><span class="st">'sepal_length'</span>,y<span class="op">=</span><span class="st">'petal_width'</span>,c<span class="op">=</span><span class="st">'petal_length'</span>,cmap<span class="op">=</span><span class="st">'winter'</span>, figsize<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">1</span>),ax<span class="op">=</span>plt.subplot(<span class="dv">111</span>))<span class="op">;</span> plt.show()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.figure()</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">#iris.plot(subplots=True, layout=(1,4)) ## Does not work as desired</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This works! -&gt; Excellent!!</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">3</span>))</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>iris.plot.scatter(x<span class="op">=</span><span class="st">'sepal_length'</span>,y<span class="op">=</span><span class="st">'petal_width'</span>,c<span class="op">=</span><span class="st">'petal_length'</span>,cmap<span class="op">=</span><span class="st">'seismic'</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>])</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>iris.plot.scatter(x<span class="op">=</span><span class="st">'sepal_length'</span>,y<span class="op">=</span><span class="st">'petal_width'</span>,c<span class="op">=</span><span class="st">'petal_length'</span>,cmap<span class="op">=</span><span class="st">'jet'</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>])</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>iris.plot.scatter(x<span class="op">=</span><span class="st">'sepal_length'</span>,y<span class="op">=</span><span class="st">'petal_width'</span>,c<span class="op">=</span><span class="st">'petal_length'</span>,cmap<span class="op">=</span><span class="st">'rainbow'</span>, ax<span class="op">=</span>axes[<span class="dv">2</span>])</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-52-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-52-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-52-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="viz-config-stuff-for-pdsnsplt" class="level2">
<h2 class="anchored" data-anchor-id="viz-config-stuff-for-pdsnsplt">Viz config stuff for pd+sns+plt</h2>
<p>I used common package abbreviation in this sub-title.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="kw">lambda</span> x: <span class="st">'</span><span class="sc">%.3f</span><span class="st">'</span> <span class="op">%</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use this to display stuff:</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>pd.options.display.max_columns <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>pd.options.display.precision</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="manhattan-plots" class="level2">
<h2 class="anchored" data-anchor-id="manhattan-plots">Manhattan Plots</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> uniform, randint</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> []</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Manhattan plot: (#optional tweaks for relplot: linewidth=0, s=9)</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> manhattan_plot(<span class="op">*</span>, data_df, x, y, regcol<span class="op">=</span><span class="st">'chrom'</span>):</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    plot <span class="op">=</span> sns.relplot(data<span class="op">=</span>data_df, x<span class="op">=</span>x, y<span class="op">=</span>y, aspect<span class="op">=</span><span class="dv">4</span>, hue<span class="op">=</span>regcol, palette <span class="op">=</span> <span class="st">'bright'</span>, legend<span class="op">=</span><span class="va">None</span>) </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    chrom_df<span class="op">=</span>data_df.groupby(regcol)[x].median()</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    plot.ax.set_xlabel(regcol)<span class="op">;</span> plot.ax.set_xticks(chrom_df)<span class="op">;</span> plot.ax.set_xticklabels(chrom_df.index)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    plot.fig.suptitle(<span class="st">'Manhattan plot'</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate DataFrame (in "plink bim like" format).</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>gwas_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="st">'rsid'</span>  : [<span class="st">'rs</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(i) <span class="cf">for</span> i <span class="kw">in</span> np.arange(<span class="dv">10000</span>)],</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="st">'pval'</span>  : uniform.rvs(size<span class="op">=</span><span class="dv">10000</span>),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="st">'chrom'</span> : [i <span class="cf">for</span> i <span class="kw">in</span> randint.rvs(<span class="dv">0</span>,<span class="dv">23</span>,size<span class="op">=</span><span class="dv">10000</span>)],</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="st">'pos'</span>   : [i <span class="cf">for</span> i <span class="kw">in</span> randint.rvs(<span class="dv">0</span>,<span class="dv">10</span><span class="op">**</span><span class="dv">5</span>,size<span class="op">=</span><span class="dv">10000</span>)]})</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>gwas_df[<span class="st">'-logp'</span>] <span class="op">=</span> <span class="op">-</span>np.log10(gwas_df.pval)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>gwas_df <span class="op">=</span> gwas_df.sort_values([<span class="st">'chrom'</span>,<span class="st">'pos'</span>])<span class="op">;</span> gwas_df.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)<span class="op">;</span> </span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>gwas_df[<span class="st">'i'</span>] <span class="op">=</span> gwas_df.index</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>drift<span class="op">=</span><span class="dv">4000</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg): <span class="co"># Function to create sampling gap in the middle of the chromosome.</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (arg <span class="op">&gt;</span> (<span class="dv">50000</span><span class="op">-</span>drift)) <span class="kw">and</span> (arg <span class="op">&lt;</span> (<span class="dv">50000</span> <span class="op">+</span> drift)):</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        arg <span class="op">=</span> randint.rvs(<span class="dv">0</span>,<span class="dv">10</span><span class="op">**</span><span class="dv">5</span>,size<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arg</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>gwas_df[<span class="st">'pos'</span>] <span class="op">=</span> gwas_df[<span class="st">'pos'</span>].<span class="bu">apply</span>(fun)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>gwas_df[<span class="st">'pos'</span>] <span class="op">=</span> gwas_df[<span class="st">'pos'</span>].<span class="bu">apply</span>(fun)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="co"># arr = np.array([res_dt['neur.train']['C'].flatten(),res_dt['neur.train']['P'].flatten()]).T</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="co"># print('---')</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span class="co"># man_df = pd.DataFrame(arr, columns=['corr','pval'], index=bim_df.index.copy())</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="co"># man_df = bim_df.merge(man_df, left_index=True, right_index=True)</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span class="co"># man_df['-logp'] = -np.log10(man_df.pval)</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a good cumpos!</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>chrom_df <span class="op">=</span> gwas_df.groupby(<span class="st">'chrom'</span>)[[<span class="st">'pos'</span>]].<span class="bu">max</span>().rename(columns<span class="op">=</span><span class="bu">dict</span>(pos<span class="op">=</span><span class="st">'maxpos'</span>))</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>chrom_df <span class="op">=</span> chrom_df.cumsum() <span class="op">-</span> chrom_df <span class="co">#df.iloc[0,0]</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>gwas_df <span class="op">=</span> gwas_df.merge(chrom_df, left_on<span class="op">=</span><span class="st">'chrom'</span>, right_on<span class="op">=</span><span class="st">'chrom'</span>)</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>gwas_df[<span class="st">'cumpos'</span>] <span class="op">=</span> gwas_df[<span class="st">'pos'</span>] <span class="op">+</span> gwas_df[<span class="st">'maxpos'</span>]</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>gwas_df[<span class="st">'i'</span>]<span class="op">=</span> gwas_df.index</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot those Manhattans!:</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>manhattan_plot(data_df<span class="op">=</span>gwas_df, x<span class="op">=</span><span class="st">'i'</span>,      y<span class="op">=</span><span class="st">'-logp'</span>)</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>manhattan_plot(data_df<span class="op">=</span>gwas_df, x<span class="op">=</span><span class="st">'cumpos'</span>, y<span class="op">=</span><span class="st">'-logp'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-67-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-67-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="data-processing-trickery-pandasnumpy" class="level1">
<h1>Data Processing Trickery (Pandas&amp;Numpy)</h1>
<section id="numpy" class="level2">
<h2 class="anchored" data-anchor-id="numpy">Numpy</h2>
<p>Should populate this later.</p>
</section>
<section id="pandas-1" class="level2">
<h2 class="anchored" data-anchor-id="pandas-1">Pandas</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">'A'</span> : [<span class="st">'foo'</span>, <span class="st">'bar'</span>, <span class="st">'foo'</span>, <span class="st">'bar'</span>,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>   ...:                           <span class="st">'foo'</span>, <span class="st">'bar'</span>, <span class="st">'foo'</span>, <span class="st">'foo'</span>],</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>   ...:                    <span class="st">'B'</span> : [<span class="st">'one'</span>, <span class="st">'one'</span>, <span class="st">'two'</span>, <span class="st">'three'</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>   ...:                           <span class="st">'two'</span>, <span class="st">'two'</span>, <span class="st">'one'</span>, <span class="st">'three'</span>],</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>   ...:                    <span class="st">'C'</span> : np.random.randn(<span class="dv">8</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>   ...:                    <span class="st">'D'</span> : np.random.randn(<span class="dv">8</span>)})</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg):</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arg.copy()</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">'A'</span>).<span class="bu">apply</span>(fun)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Sometimes ONE HAS TO USE AGG() AND PD.SERIES TO GET IT TO WORK</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">A</th>
<th data-quarto-table-cell-role="th">B</th>
<th data-quarto-table-cell-role="th">C</th>
<th data-quarto-table-cell-role="th">D</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">A</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="3" data-quarto-table-cell-role="th" data-valign="top">bar</td>
<td data-quarto-table-cell-role="th">1</td>
<td>bar</td>
<td>one</td>
<td>1.593198</td>
<td>-1.106698</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>bar</td>
<td>three</td>
<td>-0.136551</td>
<td>-1.285232</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>bar</td>
<td>two</td>
<td>-0.091798</td>
<td>-0.639158</td>
</tr>
<tr class="even">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">foo</td>
<td data-quarto-table-cell-role="th">0</td>
<td>foo</td>
<td>one</td>
<td>1.312274</td>
<td>0.644841</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>foo</td>
<td>two</td>
<td>-0.224747</td>
<td>0.654681</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>foo</td>
<td>two</td>
<td>0.123852</td>
<td>1.207584</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>foo</td>
<td>one</td>
<td>1.142278</td>
<td>-1.296145</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>foo</td>
<td>three</td>
<td>0.222377</td>
<td>-0.993053</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df.select_dtypes([np.number]).head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">C</th>
<th data-quarto-table-cell-role="th">D</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1.312274</td>
<td>0.644841</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.593198</td>
<td>-1.106698</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.224747</td>
<td>0.654681</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.136551</td>
<td>-1.285232</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.123852</td>
<td>1.207584</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>res_dt <span class="op">=</span> {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mkey1'</span>: {</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rkey1'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>],</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rkey2'</span>: [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mkey2'</span>: {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rkey3'</span>: [<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>],</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rkey4'</span>: [<span class="dv">10</span>, <span class="dv">11</span>, <span class="dv">12</span>]</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the 'fun' function</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg):</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arg</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the formula to create mod_df</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>perfnum <span class="op">=</span> <span class="va">None</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>mod_df <span class="op">=</span> pd.Series({(mkey, rkey, <span class="st">'cv'</span> <span class="op">+</span> <span class="bu">str</span>(cvi)): fun(perfnum) </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">for</span> mkey, res1_dt <span class="kw">in</span> res_dt.items()</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">for</span> rkey, res2_arr <span class="kw">in</span> res1_dt.items()</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">for</span> cvi, perfnum <span class="kw">in</span> <span class="bu">enumerate</span>(res2_arr)})</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>mod_df <span class="op">=</span> pd.DataFrame(mod_df, columns<span class="op">=</span>[<span class="st">'base'</span>])</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>mod_df.index.set_names([<span class="st">'model'</span>, <span class="st">'repit'</span>, <span class="st">'fold'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>display(mod_df, mod_df[<span class="st">'base'</span>].groupby([<span class="st">'model'</span>]).agg([np.mean,np.std]).sort_values(<span class="st">'mean'</span>))</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>display(mod_df[<span class="st">'base'</span>].groupby([<span class="st">'model'</span>]).agg([np.mean,np.std]).sort_values(<span class="st">'mean'</span>)) <span class="co">#.head())</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>display(mod_df[<span class="st">'base'</span>].unstack(<span class="st">'model'</span>).<span class="bu">apply</span>([np.mean,np.std]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">base</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">repit</th>
<th data-quarto-table-cell-role="th">fold</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="6" data-quarto-table-cell-role="th" data-valign="top">mkey1</td>
<td rowspan="3" data-quarto-table-cell-role="th" data-valign="top">rkey1</td>
<td data-quarto-table-cell-role="th">cv0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cv1</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">cv2</td>
<td>3</td>
</tr>
<tr class="even">
<td rowspan="3" data-quarto-table-cell-role="th" data-valign="top">rkey2</td>
<td data-quarto-table-cell-role="th">cv0</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">cv1</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cv2</td>
<td>6</td>
</tr>
<tr class="odd">
<td rowspan="6" data-quarto-table-cell-role="th" data-valign="top">mkey2</td>
<td rowspan="3" data-quarto-table-cell-role="th" data-valign="top">rkey3</td>
<td data-quarto-table-cell-role="th">cv0</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cv1</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">cv2</td>
<td>9</td>
</tr>
<tr class="even">
<td rowspan="3" data-quarto-table-cell-role="th" data-valign="top">rkey4</td>
<td data-quarto-table-cell-role="th">cv0</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">cv1</td>
<td>11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cv2</td>
<td>12</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">mkey1</td>
<td>3.5</td>
<td>1.870829</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mkey2</td>
<td>9.5</td>
<td>1.870829</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">mkey1</td>
<td>3.5</td>
<td>1.870829</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mkey2</td>
<td>9.5</td>
<td>1.870829</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">mkey1</th>
<th data-quarto-table-cell-role="th">mkey2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>3.500000</td>
<td>9.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>1.870829</td>
<td>1.870829</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>.xs(<span class="st">'something'</span>, level<span class="op">=</span><span class="st">'lvl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>.<span class="bu">filter</span>(like<span class="op">=</span><span class="st">'something'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># apply, transform, agg, filter</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df.rename(index<span class="op">=</span>{<span class="st">"one"</span>: <span class="st">"two"</span>, <span class="st">"y"</span>: <span class="st">"z"</span>})</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>In [<span class="dv">107</span>]: s.index.set_names([<span class="st">'L1'</span>, <span class="st">'L2'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>.unstack(<span class="st">'model'</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>tst_df.reorder_levels([<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>]).sort_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>mod_df[<span class="st">'base'</span>].groupby([<span class="st">'model'</span>]).agg([np.mean,np.std]).sort_values(<span class="st">'mean'</span>).head()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>mod_df[<span class="st">'base'</span>].unstack(<span class="st">'model'</span>).<span class="bu">apply</span>([np.mean,np.std])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>pd.read</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Nested performace estimation code:</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">## This works, but it contains waaay 2 much thinkering.</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">#nlst = ['hghgfg']</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> w(fun): <span class="cf">return</span> fun <span class="co">#lambda x: fun(x)</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun0(df): <span class="cf">return</span> pd.Series(df.<span class="bu">apply</span>(np.concatenate).values.mean(),index<span class="op">=</span>[<span class="st">'mean'</span>])</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun1(df):</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#nlst[0] = df.copy()</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> df.<span class="bu">apply</span>(np.concatenate).values.std()</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(v,index<span class="op">=</span>[<span class="st">'std'</span>])</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>fun_lst <span class="op">=</span> [w(<span class="bu">eval</span>(<span class="st">'fun'</span><span class="op">+</span><span class="bu">str</span>(i))) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>)]</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> meta(df):</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    r_lst <span class="op">=</span> []</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fun <span class="kw">in</span> fun_lst:</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        r_lst.append(fun(df))</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(r_lst)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>perf_df.groupby(<span class="st">'model'</span>).<span class="bu">apply</span>(meta).sort_values(<span class="st">'mean'</span>).iloc[::<span class="op">-</span><span class="dv">1</span>].head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arg.copy()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>this_df.set_index(<span class="st">'n_pca'</span>).groupby(<span class="st">'shift'</span>).<span class="bu">apply</span>(fun).unstack(<span class="st">'shift'</span>)[<span class="st">'r2'</span>].plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NameError: name 'this_df' is not defined</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({ <span class="st">"manager"</span>: [<span class="st">"Johns;Tim "</span>, <span class="st">"Mcgregor; Dave"</span>, <span class="st">"DeRocca; Leo"</span>, <span class="st">"Haze; Jim"</span>] ,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span>: [<span class="dv">42000</span>, <span class="dv">85000</span>, <span class="dv">45000</span>, <span class="dv">33000</span>]})<span class="op">;</span> display(df)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">'last_name'</span>,<span class="st">'first_name'</span>]] <span class="op">=</span>  df[<span class="st">'manager'</span>].<span class="bu">str</span>.split(<span class="st">";"</span>, n<span class="op">=</span><span class="dv">1</span>, expand<span class="op">=</span><span class="va">True</span>) <span class="co"># n is max number of splits</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">manager</th>
<th data-quarto-table-cell-role="th">target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Johns;Tim</td>
<td>42000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mcgregor; Dave</td>
<td>85000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>DeRocca; Leo</td>
<td>45000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Haze; Jim</td>
<td>33000</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">manager</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">first_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Johns;Tim</td>
<td>42000</td>
<td>Johns</td>
<td>Tim</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mcgregor; Dave</td>
<td>85000</td>
<td>Mcgregor</td>
<td>Dave</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>DeRocca; Leo</td>
<td>45000</td>
<td>DeRocca</td>
<td>Leo</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Haze; Jim</td>
<td>33000</td>
<td>Haze</td>
<td>Jim</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Explode dict colunms:</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">"A"</span>:[{<span class="st">"a"</span>:<span class="dv">3</span>},{<span class="st">"b"</span>:<span class="dv">4</span>,<span class="st">"c"</span>:<span class="dv">5</span>}], <span class="st">"B"</span>:[<span class="dv">6</span>,<span class="dv">7</span>]})</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>display(df)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'A'</span>].<span class="bu">apply</span>(pd.Series)<span class="op">;</span> display(_)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat([df, df[<span class="st">"A"</span>].<span class="bu">apply</span>(pd.Series)], axis<span class="op">=</span><span class="dv">1</span>)<span class="op">;</span> display(df)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'-- Another way to explode dicts: --'</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">"A"</span>:[{<span class="st">"a"</span>:<span class="dv">3</span>},{<span class="st">"b"</span>:<span class="dv">4</span>,<span class="st">"c"</span>:<span class="dv">5</span>}], <span class="st">"B"</span>:[<span class="dv">6</span>,<span class="dv">7</span>]})</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(df[<span class="st">'A'</span>].to_list()) </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'-- 2 more ways --'</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>df.join(pd.json_normalize(df.A))<span class="op">;</span> display(_)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>df.join(df.A.<span class="bu">apply</span>(pd.Series))<span class="op">;</span> display(_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">A</th>
<th data-quarto-table-cell-role="th">B</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>{'a': 3}</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>{'b': 4, 'c': 5}</td>
<td>7</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">manager</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">first_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Johns;Tim</td>
<td>42000</td>
<td>Johns</td>
<td>Tim</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mcgregor; Dave</td>
<td>85000</td>
<td>Mcgregor</td>
<td>Dave</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>DeRocca; Leo</td>
<td>45000</td>
<td>DeRocca</td>
<td>Leo</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Haze; Jim</td>
<td>33000</td>
<td>Haze</td>
<td>Jim</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">A</th>
<th data-quarto-table-cell-role="th">B</th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
<th data-quarto-table-cell-role="th">c</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>{'a': 3}</td>
<td>6</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>{'b': 4, 'c': 5}</td>
<td>7</td>
<td>NaN</td>
<td>4.0</td>
<td>5.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>-- Another way to explode dicts: --
-- 2 more ways --</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">manager</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">first_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Johns;Tim</td>
<td>42000</td>
<td>Johns</td>
<td>Tim</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mcgregor; Dave</td>
<td>85000</td>
<td>Mcgregor</td>
<td>Dave</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>DeRocca; Leo</td>
<td>45000</td>
<td>DeRocca</td>
<td>Leo</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Haze; Jim</td>
<td>33000</td>
<td>Haze</td>
<td>Jim</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">manager</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">last_name</th>
<th data-quarto-table-cell-role="th">first_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Johns;Tim</td>
<td>42000</td>
<td>Johns</td>
<td>Tim</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mcgregor; Dave</td>
<td>85000</td>
<td>Mcgregor</td>
<td>Dave</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>DeRocca; Leo</td>
<td>45000</td>
<td>DeRocca</td>
<td>Leo</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Haze; Jim</td>
<td>33000</td>
<td>Haze</td>
<td>Jim</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.DataFrame(df['A'].to_list())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ml-recipes" class="level1">
<h1>ML Recipes</h1>
<section id="pytorch-101" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-101">Pytorch 101</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  -*- coding: utf-8 -*-</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Tensors to hold input and outputs.</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.linspace(<span class="op">-</span>math.pi, math.pi, <span class="dv">2000</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> torch.sin(x)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co"># For this example, the output y is a linear function of (x, x^2, x^3), so</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co"># we can consider it as a linear layer neural network. Let's prepare the</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co"># tensor (x, x^2, x^3).</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> torch.tensor([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>])</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>xx <span class="op">=</span> x.unsqueeze(<span class="op">-</span><span class="dv">1</span>).<span class="bu">pow</span>(p)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="co"># In the above code, x.unsqueeze(-1) has shape (2000, 1), and p has shape</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="co"># (3,), for this case, broadcasting semantics will apply to obtain a tensor</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="co"># of shape (2000, 3) </span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the nn package to define our model as a sequence of layers. nn.Sequential</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="co"># is a Module which contains other Modules, and applies them in sequence to</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="co"># produce its output. The Linear Module computes output from input using a</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="co"># linear function, and holds internal Tensors for its weight and bias.</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="co"># The Flatten layer flatens the output of the linear layer to a 1D tensor,</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="co"># to match the shape of `y`.</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> torch.nn.Sequential(</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    torch.nn.Linear(<span class="dv">3</span>, <span class="dv">1</span>),</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    torch.nn.Flatten(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a><span class="co"># The nn package also contains definitions of popular loss functions; in this</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a><span class="co"># case we will use Mean Squared Error (MSE) as our loss function.</span></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>loss_fn <span class="op">=</span> torch.nn.MSELoss(reduction<span class="op">=</span><span class="st">'sum'</span>)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2000</span>):</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward pass: compute predicted y by passing x to the model. Module objects</span></span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># override the __call__ operator so you can call them like functions. When</span></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># doing so you pass a Tensor of input data to the Module and it produces</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a Tensor of output data.</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> model(xx)</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute and print loss. We pass Tensors containing the predicted and true</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># values of y, and the loss function returns a Tensor containing the</span></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loss.</span></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> loss_fn(y_pred, y)</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> t <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">99</span>:</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(t, loss.item())</span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Zero the gradients before running the backward pass.</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>    model.zero_grad()</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Backward pass: compute gradient of the loss with respect to all the learnable</span></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parameters of the model. Internally, the parameters of each Module are stored</span></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in Tensors with requires_grad=True, so this call will compute gradients for</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># all learnable parameters in the model.</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the weights using gradient descent. Each parameter is a Tensor, so</span></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we can access its gradients like we did before.</span></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> param <span class="kw">in</span> model.parameters():</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>            param <span class="op">-=</span> learning_rate <span class="op">*</span> param.grad</span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a><span class="co"># You can access the first layer of `model` like accessing the first item of a list</span></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>linear_layer <span class="op">=</span> model[<span class="dv">0</span>]</span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a><span class="co"># For linear layer, its parameters are stored as `weight` and `bias`.</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Result: y = </span><span class="sc">{</span>linear_layer<span class="sc">.</span>bias<span class="sc">.</span>item()<span class="sc">}</span><span class="ss"> + </span><span class="sc">{</span>linear_layer<span class="sc">.</span>weight[:, <span class="dv">0</span>]<span class="sc">.</span>item()<span class="sc">}</span><span class="ss"> x + </span><span class="sc">{</span>linear_layer<span class="sc">.</span>weight[:, <span class="dv">1</span>]<span class="sc">.</span>item()<span class="sc">}</span><span class="ss"> x^2 + </span><span class="sc">{</span>linear_layer<span class="sc">.</span>weight[:, <span class="dv">2</span>]<span class="sc">.</span>item()<span class="sc">}</span><span class="ss"> x^3'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>99 505.64410400390625
199 337.98028564453125
299 226.92686462402344
399 153.361083984375
499 104.6224136352539
599 72.3280029296875
699 50.92662048339844
799 36.74208450317383
899 27.339014053344727
999 21.10478401184082
1099 16.970691680908203
1199 14.228747367858887
1299 12.409767150878906
1399 11.202799797058105
1499 10.401751518249512
1599 9.87000560760498
1699 9.516922950744629
1799 9.282390594482422
1899 9.126569747924805
1999 9.023015975952148
Result: y = 0.004640887025743723 + 0.8434610962867737 x + -0.0008006299030967057 x^2 + -0.09144145995378494 x^3</code></pre>
</div>
</div>
</section>
<section id="keras-snippet" class="level2">
<h2 class="anchored" data-anchor-id="keras-snippet">Keras Snippet</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, Dropout</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Model, Sequential</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.wrappers.scikit_learn <span class="im">import</span> KerasRegressor</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor, GradientBoostingRegressor</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression, RANSACRegressor, TheilSenRegressor, HuberRegressor, LassoCV, LarsCV, Lars</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier, KNeighborsRegressor</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> auc, make_scorer, roc_auc_score, r2_score</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold, train_test_split</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> pearsonr, spearmanr</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co"># from keras import Sequential</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co"># from keras.layers import Dense, Dropout</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>res_dt <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pearson_score(y_true, y_pred):</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pearsonr(y_true, y_pred)[<span class="dv">0</span>]</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spearman_score(y_true, y_pred):</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> spearmanr(y_true, y_pred)[<span class="dv">0</span>]</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(optimizer<span class="op">=</span><span class="st">'sgd'</span>,</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>                 kernel_initializer<span class="op">=</span><span class="st">'glorot_uniform'</span>, </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>                 dropout<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential()</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    model.add(Dense(<span class="dv">10</span>,activation<span class="op">=</span><span class="st">'tanh'</span>,kernel_initializer<span class="op">=</span>kernel_initializer))</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    model.add(Dropout(dropout))</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>    model.add(Dense(<span class="dv">10</span>,activation<span class="op">=</span><span class="st">'tanh'</span>,kernel_initializer<span class="op">=</span>kernel_initializer))</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    model.add(Dropout(dropout))</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     model.add(Dropout(dropout))</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     model.add(Dense(128,activation='tanh',kernel_initializer=kernel_initializer))</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     model.add(Dropout(dropout))</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    model.add(Dense(<span class="dv">1</span>,activation<span class="op">=</span><span class="st">'linear'</span>,kernel_initializer<span class="op">=</span>kernel_initializer))</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">'mean_squared_error'</span>,optimizer<span class="op">=</span>optimizer, metrics<span class="op">=</span>[<span class="st">'accuracy'</span>])</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a><span class="co"># wrap the model using the function you created</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>dnn <span class="op">=</span> KerasRegressor(build_fn<span class="op">=</span>create_model, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a><span class="co"># just create the pipeline</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a><span class="co"># pipeline = Pipeline([</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     ('clf',clf)</span></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ])</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a><span class="co"># pipeline.fit(X_train, y_train)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gaussian-processes" class="level2">
<h2 class="anchored" data-anchor-id="gaussian-processes">Gaussian Processes</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">##################################################</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Basic setup</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> load_wine</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>wine_dt <span class="op">=</span> load_wine()</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>wine_df <span class="op">=</span> pd.DataFrame(wine_dt[<span class="st">'data'</span>],columns<span class="op">=</span>wine_dt[<span class="st">'feature_names'</span>])</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> wine_df.values</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>n,p <span class="op">=</span> X.shape</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>Sigma <span class="op">=</span> X.T.dot(X)<span class="op">/</span>n<span class="op">;</span> <span class="bu">print</span>(<span class="st">'Sigma.shape -&gt; '</span>, Sigma.shape)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">###################################################</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="co">## Generate Basic sample from Multivariate Normal:</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.multivariate_normal(np.zeros(p),Sigma)</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sigma.shape -&gt;  (13, 13)
[3.89132606e+01 8.12103938e+00 6.87224463e+00 5.69947022e+01
 3.05815577e+02 7.50441890e+00 6.04952658e+00 7.70976236e-01
 4.46277373e+00 1.11720361e+01 2.68117246e+00 8.21249076e+00
 1.90230019e+03]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Generate from Kernels: RBF</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co">####################################################</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.linspace(<span class="fl">0.0</span>,<span class="fl">1.0</span>,p)[:,np.newaxis]</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>line_df <span class="op">=</span> pd.DataFrame(X)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(a,b):</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (s<span class="op">**</span><span class="fl">2.0</span>)<span class="op">*</span>np.exp(<span class="op">-</span>((a<span class="op">-</span>b)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>l<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> line_df.T.corr(method<span class="op">=</span>fun)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>,<span class="dv">4</span>])<span class="op">;</span> plt.imshow(S)<span class="op">;</span> plt.colorbar()<span class="op">;</span> plt.show()</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>x_smp <span class="op">=</span> np.random.multivariate_normal(np.zeros(p),S) <span class="co"># Native cholesky from np.linalg has issues, this uses svd</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>,<span class="dv">4</span>])<span class="op">;</span> plt.plot(x_smp)<span class="op">;</span> plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-121-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-121-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Generate from Kernels: RBF</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co">####################################################</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.linspace(<span class="fl">0.0</span>,<span class="fl">1.0</span>,p)[:,np.newaxis]</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>line_df <span class="op">=</span> pd.DataFrame(X)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>per <span class="op">=</span> <span class="fl">.2</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>s<span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(a,b):</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (s<span class="op">**</span><span class="fl">2.0</span>)<span class="op">*</span>np.exp((<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.sin(np.pi<span class="op">*</span>np.<span class="bu">abs</span>(a<span class="op">-</span>b)<span class="op">/</span>per)<span class="op">**</span><span class="dv">2</span>)<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>l<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> line_df.T.corr(method<span class="op">=</span>fun)</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>,<span class="dv">4</span>])<span class="op">;</span> plt.imshow(S)<span class="op">;</span> plt.colorbar()<span class="op">;</span> plt.show()</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>x_smp <span class="op">=</span> np.random.multivariate_normal(np.zeros(p),S) <span class="co"># Native cholesky from np.linalg has issues, this uses svd</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>[<span class="dv">8</span>,<span class="dv">4</span>])<span class="op">;</span> plt.plot(x_smp)<span class="op">;</span> plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-124-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="ipynb_snippets_files/figure-html/cell-124-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="recipe-resources" class="level2">
<h2 class="anchored" data-anchor-id="recipe-resources">Recipe Resources</h2>
<ul>
<li>Awesome Brit @ pydata Amsterdam, debugging ML models: https://www.youtube.com/watch?v=DkLPYccEJ8Y</li>
<li>maybe mildly interesting: https://www.youtube.com/watch?v=kbj3llSbaVA similar topic</li>
</ul>
</section>
</section>
<section id="threading-multiprocessing-sys-ops" class="level1">
<h1>Threading, Multiprocessing &amp; Sys-Ops</h1>
<section id="ram-usage" class="level2">
<h2 class="anchored" data-anchor-id="ram-usage">RAM usage:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, psutil</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>process <span class="op">=</span> psutil.Process(os.getpid())</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(process.memory_info().rss<span class="op">/</span><span class="dv">1024</span><span class="op">**</span><span class="dv">3</span>)  <span class="co"># in bytes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.23577880859375</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ramgb?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vanilla" class="level2">
<h2 class="anchored" data-anchor-id="vanilla">Vanilla (?)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Still nothing like parfor...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>i <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys,copy</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg_dt, something<span class="op">=</span><span class="st">'ergerg'</span>):</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    sys._getframe(<span class="dv">1</span>).f_locals.update(<span class="op">**</span>arg_dt)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#locals().update(**arg_dt) # &lt;-- will not work</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    q<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect.currentframe().f_locals['foo'] = 'bar'</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>lst <span class="op">=</span> []  <span class="op">;</span> lst2 <span class="op">=</span> []<span class="op">;</span> lst3 <span class="op">=</span> []</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    ndt <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    ndt.update(<span class="op">**</span><span class="bu">locals</span>())</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    ndt[<span class="st">'i'</span>] <span class="op">=</span> copy.copy(ndt[<span class="st">'i'</span>])<span class="op">*</span><span class="fl">1.0</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    lst2.append(ndt)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    lst3.append(fun)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    lst.append(partial(lst3[<span class="op">-</span><span class="dv">1</span>], lst2[<span class="op">-</span><span class="dv">1</span>])) <span class="co"># Partial stuff does not work with locals trickery</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x: x(), lst)))</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(<span class="bu">map</span>(fun,lst2)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[5, 5, 5, 5, 5]
[1.0, 2.0, 3.0, 4.0, 5.0]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> threading <span class="im">import</span> Thread</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>tdt <span class="op">=</span> {}</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>arg <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun():</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> arg <span class="op">+</span> <span class="dv">5</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    tdt[<span class="st">'res'</span>] <span class="op">=</span> res</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>tobj <span class="op">=</span> Thread(target<span class="op">=</span>fun)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>tt <span class="op">=</span> tobj.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> tobj.join()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tobj.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Thread(Thread-6 (fun), stopped 139627026589248)&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tt</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>fun()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>8</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ergerg</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from multiprocessing import Pool </span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> multiprocessing.pool <span class="im">import</span> ThreadPool, Pool</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    pool.close()</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co"># pool = Pool(10)</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>pool <span class="op">=</span> ThreadPool(<span class="dv">10</span>)</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'this'</span>)</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>nanidx_dt <span class="op">=</span> {}</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foo_pool(i, iid, slice_arr):</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    nanidx_sampi_arr <span class="op">=</span> np.nonzero(int8_trn_sda.val[i,:].copy() <span class="op">==</span> <span class="op">-</span><span class="dv">127</span>)[<span class="dv">0</span>]</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     nanidx_sampi_arr = np.nonzero(slice_arr == -127)[0]</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> i, <span class="st">'_'</span>.join(iid), nanidx_sampi_arr</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_result(res):</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    i , iid_key, slice_arr <span class="op">=</span> res</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is called whenever foo_pool(i) returns a result.</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># result_list is modified only by the main process, not the pool workers.</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     print('inside :',i)</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    nanidx_dt[iid_key] <span class="op">=</span> slice_arr</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     nanidx_lst.append(slice_arr)</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, iid <span class="kw">in</span> <span class="bu">enumerate</span>(int8_trn_sda.iid):</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>    rr <span class="op">=</span> pool.apply_async(foo_pool, args <span class="op">=</span> (i, iid, <span class="dv">0</span>), callback<span class="op">=</span>log_result)</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.mod(i, <span class="dv">2000</span>) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'this: '</span>, i, end<span class="op">=</span><span class="st">'</span><span class="ch">\r</span><span class="st">'</span>)</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.02</span>)</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f't-step:</span><span class="sc">{</span><span class="bu">len</span>(tc_lst)<span class="sc">}</span><span class="ss">'</span>, time.time()<span class="op">-</span>tc_lst[<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span> tc_lst.append(time.time())<span class="op">;</span></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">len</span>(nanidx_dt.keys()) <span class="op">&lt;</span> (<span class="dv">200000</span><span class="op">-</span><span class="dv">5</span>):</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">5</span>)</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'bing'</span>, end<span class="op">=</span><span class="st">', '</span>)</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f't-step:</span><span class="sc">{</span><span class="bu">len</span>(tc_lst)<span class="sc">}</span><span class="ss">'</span>, time.time()<span class="op">-</span>tc_lst[<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span> tc_lst.append(time.time())<span class="op">;</span></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>pool.close()</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>pool.join()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>this</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>NameError: name 'int8_trn_sda' is not defined</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor <span class="co">#, ProcessPoolExecutor</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>pool <span class="op">=</span> ThreadPoolExecutor(<span class="dv">4</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>tdt <span class="op">=</span> {}</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg):</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> arg<span class="op">*</span><span class="fl">1.9</span> <span class="op">+</span> <span class="dv">5</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    tdt[arg] <span class="op">=</span> res</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>fut <span class="op">=</span> pool.submit(fun, arg)</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fut.result(), <span class="st">'(Takes a second)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>9.9 (Takes a second)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>fut_lst <span class="op">=</span> []</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>arg_lst <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">9</span>]</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>tdt <span class="op">=</span> {}</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(arg):</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">10</span>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> arg<span class="op">*</span><span class="fl">1.9</span> <span class="op">+</span> <span class="dv">5</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    tdt[arg] <span class="op">=</span> res</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> arg <span class="kw">in</span> arg_lst:</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    fut <span class="op">=</span> pool.submit(fun, arg)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    fut_lst.append(fut)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pool._work_queue.qsize())</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>res_lst <span class="op">=</span> [fut.result() <span class="cf">for</span> fut <span class="kw">in</span> fut_lst]</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res_lst, <span class="st">'(Takes seconds)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5
[9.9, 11.8, 13.7, 15.6, 17.5, 19.4, 21.299999999999997, 23.2, 25.099999999999998] (Takes seconds)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the option for which there is no code here:</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>concurrent.futures</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="submitit-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="submitit-pipeline">Submitit pipeline</h2>
<section id="basic-setup" class="level3">
<h3 class="anchored" data-anchor-id="basic-setup">Basic setup</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to execute on cluster:</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_blrjob(model<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    tic()<span class="op">;</span> <span class="bu">print</span>(model)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    model.fit(X,y)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    toc()</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Executor:</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>log_folder <span class="op">=</span> <span class="st">"/home/mennow/dsmwpred/mennow/log_test/%j"</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>executor <span class="op">=</span> submitit.AutoExecutor(folder<span class="op">=</span>log_folder)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>executor.update_parameters(slurm_mem<span class="op">=</span><span class="st">'100G'</span>, cpus_per_task<span class="op">=</span><span class="dv">15</span>, slurm_time<span class="op">=</span><span class="st">'10:04:00'</span>,slurm_additional_parameters<span class="op">=</span>{<span class="st">'account'</span>: <span class="st">'risk_prediction'</span>}) </span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co">#slurm_account='risk_prediction')</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Jobs specs:</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>job_dt <span class="op">=</span> {}</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, model <span class="kw">in</span> model_dt.items():</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    job_dt[key] <span class="op">=</span> executor.submit(run_blrjob, model<span class="op">=</span>model)</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Check:</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'and after:'</span>) </span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>que</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>que <span class="co"># Should I add this to my mjwt package?</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/bin/bash: line 1: que: command not found</code></pre>
</div>
</div>
</section>
<section id="parameter-grid" class="level3">
<h3 class="anchored" data-anchor-id="parameter-grid">Parameter Grid</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach version I:</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> ParameterGrid</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [chaindt(minidt for minidt in dt.values()) for dt in params_lst]</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nans2nones(in_df):</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    isna <span class="op">=</span> in_df.isna().values</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    vals <span class="op">=</span> in_df.values<span class="op">;</span> vals[isna] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(vals, index<span class="op">=</span>in_df.index, columns<span class="op">=</span>in_df.columns)</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>ld_lst <span class="op">=</span> [</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(cm<span class="op">=</span><span class="fl">0.01</span>, shift<span class="op">=</span><span class="dv">0</span>), <span class="co">#0</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(cm<span class="op">=</span><span class="fl">2.0</span>,  shift<span class="op">=</span><span class="dv">0</span>), <span class="co">#3</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(cm<span class="op">=</span><span class="fl">10.0</span>, shift<span class="op">=</span><span class="dv">0</span>), <span class="co">#6</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>fold_lst <span class="op">=</span> [</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(fold<span class="op">=</span><span class="st">'val'</span>, geno_fn<span class="op">=</span><span class="st">'UKBB.val'</span>),</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(fold<span class="op">=</span><span class="st">'test'</span>, geno_fn<span class="op">=</span><span class="st">'UKBB.test'</span>)</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>dtype_lst <span class="op">=</span> [</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(dtype<span class="op">=</span><span class="st">'float32'</span>),</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(dtype<span class="op">=</span><span class="st">'float64'</span>)</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>    ld    <span class="op">=</span> ld_lst,</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>    fold  <span class="op">=</span> fold_lst,</span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>    dtype <span class="op">=</span> dtype_lst</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>params_lst <span class="op">=</span> <span class="bu">list</span>(ParameterGrid(dt))</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(params_lst)</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>param_df <span class="op">=</span> pd.concat([df[cols].<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series(x, dtype<span class="op">=</span><span class="st">'object'</span>)) <span class="cf">for</span> cols <span class="kw">in</span> df.columns], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>param_df <span class="op">=</span> nans2nones(param_df)</span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a><span class="co"># param_df.T.to_dict()</span></span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>param_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dtype</th>
<th data-quarto-table-cell-role="th">fold</th>
<th data-quarto-table-cell-role="th">geno_fn</th>
<th data-quarto-table-cell-role="th">cm</th>
<th data-quarto-table-cell-role="th">shift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>float32</td>
<td>val</td>
<td>UKBB.val</td>
<td>0.01</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>float32</td>
<td>val</td>
<td>UKBB.val</td>
<td>2.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>float32</td>
<td>val</td>
<td>UKBB.val</td>
<td>10.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>float32</td>
<td>test</td>
<td>UKBB.test</td>
<td>0.01</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>float32</td>
<td>test</td>
<td>UKBB.test</td>
<td>2.0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach version II:</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Grid Hyperparams:</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>n_reps <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>n_iter_arr <span class="op">=</span> np.array([<span class="dv">10</span>])</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>h2_arr     <span class="op">=</span> np.<span class="bu">round</span>(np.logspace(log(<span class="fl">0.05</span>),log(<span class="fl">0.9</span>),<span class="dv">8</span>),<span class="dv">3</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>random_state <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="st">'L2Pred'</span> <span class="kw">in</span> <span class="bu">locals</span>(): <span class="co"># Trick</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> L2Pred: <span class="cf">pass</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create param_df:</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>param_df <span class="op">=</span> pd.DataFrame([<span class="dv">0</span>],columns<span class="op">=</span>[<span class="st">'null'</span>])</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign fun:</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_fun(arg_df, <span class="op">**</span>kwargs):</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    arg_df <span class="op">=</span> arg_df.copy()</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key,item <span class="kw">in</span> kwargs.items():</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>        arg_df[key] <span class="op">=</span> [item] <span class="op">*</span> arg_df.shape[<span class="dv">0</span>]</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arg_df</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Data specs:</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>dataspec_lst <span class="op">=</span> []</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_reps):</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    dataspec_lst <span class="op">=</span> dataspec_lst <span class="op">+</span> [</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>        (<span class="bu">dict</span>(random_state<span class="op">=</span>random_state<span class="op">+</span>i, pheno<span class="op">=</span>pheno)) <span class="cf">for</span> pheno <span class="kw">in</span> [<span class="st">'PRCA'</span>,<span class="st">'TURBO'</span>]</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>param_df <span class="op">=</span> pd.concat([assign_fun(param_df, dwargs<span class="op">=</span>dkwargs)</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> dkwargs <span class="kw">in</span> dataspec_lst]</span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>                    ).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specs:</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>modelspec_lst <span class="op">=</span> [</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>((L2Pred, <span class="bu">dict</span>(something<span class="op">=</span><span class="st">'this'</span>, h2<span class="op">=</span>h2, n_iter<span class="op">=</span>n_iter)) <span class="cf">for</span> h2 <span class="kw">in</span> h2_arr <span class="cf">for</span> n_iter <span class="kw">in</span> n_iter_arr),</span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>((L2Pred, <span class="bu">dict</span>(something<span class="op">=</span><span class="st">'that'</span>, h2<span class="op">=</span>h2, n_iter<span class="op">=</span>n_iter)) <span class="cf">for</span> h2 <span class="kw">in</span> h2_arr <span class="cf">for</span> n_iter <span class="kw">in</span> n_iter_arr)</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>param_df <span class="op">=</span> pd.concat([assign_fun(param_df, mclass<span class="op">=</span>mclass, mkwargs<span class="op">=</span>mkwargs)</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> mclass, mkwargs <span class="kw">in</span> modelspec_lst]</span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>                    ).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>display(param_df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">null</th>
<th data-quarto-table-cell-role="th">dwargs</th>
<th data-quarto-table-cell-role="th">mclass</th>
<th data-quarto-table-cell-role="th">mkwargs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>&lt;class '__main__.L2Pred'&gt;</td>
<td>{'something': 'this', 'h2': 0.05, 'n_iter': 10}</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>{'random_state': 42, 'pheno': 'TURBO'}</td>
<td>&lt;class '__main__.L2Pred'&gt;</td>
<td>{'something': 'this', 'h2': 0.05, 'n_iter': 10}</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>&lt;class '__main__.L2Pred'&gt;</td>
<td>{'something': 'this', 'h2': 0.076, 'n_iter': 10}</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>{'random_state': 42, 'pheno': 'TURBO'}</td>
<td>&lt;class '__main__.L2Pred'&gt;</td>
<td>{'something': 'this', 'h2': 0.076, 'n_iter': 10}</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>&lt;class '__main__.L2Pred'&gt;</td>
<td>{'something': 'this', 'h2': 0.114, 'n_iter': 10}</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach version III:</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Grid Hyperparams:</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>n_reps <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>n_iter_arr <span class="op">=</span> np.array([<span class="dv">10</span>])</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>h2_arr     <span class="op">=</span> np.<span class="bu">round</span>(np.logspace(log(<span class="fl">0.05</span>),log(<span class="fl">0.9</span>),<span class="dv">8</span>),<span class="dv">3</span>)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>random_state <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="st">'L2Pred'</span> <span class="kw">in</span> <span class="bu">locals</span>(): <span class="co"># Trick</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> L2Pred: <span class="cf">pass</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Data specs:</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>dataspec_lst <span class="op">=</span> []</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_reps):</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    dataspec_lst <span class="op">=</span> dataspec_lst <span class="op">+</span> [</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>        (<span class="bu">dict</span>(random_state<span class="op">=</span>random_state<span class="op">+</span>i, pheno<span class="op">=</span>pheno)) <span class="cf">for</span> pheno <span class="kw">in</span> [<span class="st">'PRCA'</span>,<span class="st">'TURBO'</span>]</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specs:</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>modelspec_lst <span class="op">=</span> [</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>((L2Pred, <span class="bu">dict</span>(something<span class="op">=</span><span class="st">'this'</span>, h2<span class="op">=</span>h2, n_iter<span class="op">=</span>n_iter)) <span class="cf">for</span> h2 <span class="kw">in</span> h2_arr <span class="cf">for</span> n_iter <span class="kw">in</span> n_iter_arr),</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>((L2Pred, <span class="bu">dict</span>(something<span class="op">=</span><span class="st">'that'</span>, h2<span class="op">=</span>h2, n_iter<span class="op">=</span>n_iter)) <span class="cf">for</span> h2 <span class="kw">in</span> h2_arr <span class="cf">for</span> n_iter <span class="kw">in</span> n_iter_arr)</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>dwargs <span class="op">=</span> dataspec_lst,</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>mkwargs <span class="op">=</span> modelspec_lst,</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> pd.DataFrame(ParameterGrid(dt))</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>grid.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dwargs</th>
<th data-quarto-table-cell-role="th">mkwargs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>(&lt;class '__main__.L2Pred'&gt;, {'something': 'this', 'h2': 0.05, 'n_iter': 10})</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>(&lt;class '__main__.L2Pred'&gt;, {'something': 'this', 'h2': 0.076, 'n_iter': 10})</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>(&lt;class '__main__.L2Pred'&gt;, {'something': 'this', 'h2': 0.114, 'n_iter': 10})</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>(&lt;class '__main__.L2Pred'&gt;, {'something': 'this', 'h2': 0.173, 'n_iter': 10})</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>{'random_state': 42, 'pheno': 'PRCA'}</td>
<td>(&lt;class '__main__.L2Pred'&gt;, {'something': 'this', 'h2': 0.261, 'n_iter': 10})</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="job-processing" class="level3">
<h3 class="anchored" data-anchor-id="job-processing">Job processing</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Define Internal Executor:</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>debug <span class="op">=</span> <span class="va">False</span><span class="op">;</span> <span class="bu">print</span>(<span class="st">'debug ='</span>, debug)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>folder <span class="op">=</span> <span class="st">"../lnk/menno/log_test/%j"</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>executor <span class="op">=</span> submitit.AutoExecutor(folder<span class="op">=</span>folder)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>executor.update_parameters(slurm_mem<span class="op">=</span><span class="st">'119G'</span>, cpus_per_task<span class="op">=</span><span class="dv">15</span>, slurm_time<span class="op">=</span><span class="st">'11:54:00'</span>,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>                           slurm_additional_parameters<span class="op">=</span>{<span class="st">'account'</span>: <span class="st">'NCRR'</span>})</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> debug:</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    make_brd_df <span class="op">=</span> <span class="kw">lambda</span> : brd </span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> make_brd_df(fn<span class="op">=</span><span class="st">'../results/betas/final/all-betas.pst.h5'</span>):</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        brd <span class="op">=</span> PstHdf5(fn)</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> brd</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> debug_make_pheno_df(fold<span class="op">=</span><span class="st">'test'</span>):</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pheno_df</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>wrapped_make_pheno_df <span class="op">=</span> debug_make_pheno_df <span class="cf">if</span> debug <span class="cf">else</span> make_pheno_df</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>job_dt <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, cfg_dt <span class="kw">in</span> param_df.T.to_dict().items(): </span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ppb_fun():</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>        xp_dt <span class="op">=</span> experimental_setup(geno_fn<span class="op">=</span>cfg_dt[<span class="st">'geno_fn'</span>], fold<span class="op">=</span>cfg_dt[<span class="st">'fold'</span>], shift<span class="op">=</span>cfg_dt[<span class="st">'shift'</span>], gb_size_limit<span class="op">=</span><span class="fl">19.</span>, cm<span class="op">=</span>cfg_dt[<span class="st">'cm'</span>], dtype<span class="op">=</span>cfg_dt[<span class="st">'dtype'</span>]) </span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>        pheno_df <span class="op">=</span> wrapped_make_pheno_df(fold<span class="op">=</span>cfg_dt[<span class="st">'fold'</span>])</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>        brd <span class="op">=</span> make_brd_df()</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>        tst_prd <span class="op">=</span> Pheno(<span class="bu">dict</span>(iid<span class="op">=</span>pheno_df.index.to_frame()[[<span class="st">'fid'</span>,<span class="st">'iid'</span>]].values.astype(<span class="bu">str</span>),</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>                   vals<span class="op">=</span>pheno_df.values, header<span class="op">=</span><span class="bu">list</span>(pheno_df.columns)))</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>        cur_srd, cur_prd <span class="op">=</span> pstutil.intersect_apply([xp_dt[<span class="st">'tst_srd'</span>], tst_prd])</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>        pgm <span class="op">=</span> MultiPGSModel(brd<span class="op">=</span>brd, verbose<span class="op">=</span><span class="va">True</span>, dtype<span class="op">=</span>cfg_dt[<span class="st">'dtype'</span>])</span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>        pred_dt <span class="op">=</span> pgm.predict(srd<span class="op">=</span>cur_srd, prd<span class="op">=</span>cur_prd)</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>        linkdata <span class="op">=</span> xp_dt[<span class="st">'tst_linkdata'</span>]</span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>        mc <span class="op">=</span> PrivacyPreservingMetricsComputer(linkdata<span class="op">=</span>linkdata, brd<span class="op">=</span>brd, s<span class="op">=</span>pred_dt[<span class="st">'s'</span>], Bm<span class="op">=</span>pred_dt[<span class="st">'Bm'</span>], cov_method<span class="op">=</span><span class="st">'local'</span>, dtype<span class="op">=</span>cfg_dt[<span class="st">'dtype'</span>], clear_linkage<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>        mcres_dt <span class="op">=</span> mc.evaluate(debug<span class="op">=</span>debug)</span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>        C <span class="op">=</span> corr(pred_dt[<span class="st">'Ytru'</span>].astype(cfg_dt[<span class="st">'dtype'</span>]), pred_dt[<span class="st">'Yhat'</span>].astype(cfg_dt[<span class="st">'dtype'</span>]))</span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>        res_dt <span class="op">=</span> <span class="bu">dict</span>(brd<span class="op">=</span>pred_dt[<span class="st">'brd'</span>], C<span class="op">=</span>C,</span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>                      Bm<span class="op">=</span>pred_dt[<span class="st">'Bm'</span>], stansda<span class="op">=</span>pred_dt[<span class="st">'stansda'</span>], </span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>                      mcres_dt<span class="op">=</span>mcres_dt, linkdata<span class="op">=</span>linkdata)</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> res_dt</span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>    job_dt[i] <span class="op">=</span> executor.submit(ppb_fun)</span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'submitted: '</span>, i, end<span class="op">=</span><span class="st">'</span><span class="ch">\r</span><span class="st">'</span>)</span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'done'</span>)</span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a>eval_job_dt <span class="op">=</span> job_dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="profling" class="level2">
<h2 class="anchored" data-anchor-id="profling">Profling</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> line_profiler</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co"># other example:</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co"># %lprun -f experimental_setup experimental_setup(decomp_fun=vanilla_svd, filter_str='minitest')</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Also if there is no code showm, perhaps try to update package line_profiler</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ModuleNotFoundError: No module named 'line_profiler'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun():</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    n<span class="op">=</span> <span class="dv">100</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> np.random.randn(n,n)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    D <span class="op">=</span> X.T<span class="op">@</span>X<span class="op">/</span>n</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">50</span>):</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>        a,b,c <span class="op">=</span> linalg.svd(D)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>        invt_chol <span class="op">=</span> linalg.cholesky(D <span class="op">+</span> np.eye(n)<span class="op">*</span><span class="fl">0.01</span>)</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>prof <span class="op">=</span> <span class="op">%</span>lprun <span class="op">-</span>r <span class="op">-</span>f fun res<span class="op">=</span>fun()</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>prof.print_stats()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Timer unit: 1e-09 s

Total time: 0.14446 s
File: /tmp/ipykernel_1752/2008979480.py
Function: fun at line 1

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     1                                           def fun():
     2         1       1112.0   1112.0      0.0      n= 100
     3         1     357956.0 357956.0      0.2      X = np.random.randn(n,n)
     4         1     463782.0 463782.0      0.3      D = X.T@X/n
     5        50      45637.0    912.7      0.0      for i in range(50):
     6        50  125506374.0 2510127.5     86.9          a,b,c = linalg.svd(D)
     7        50   18085045.0 361700.9     12.5          invt_chol = linalg.cholesky(D + np.eye(n)*0.01)
</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> tqdm(<span class="bu">range</span>(<span class="dv">6</span>)):</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d18fe5d331774caa9f79470eeee7eccf","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="timing-experiments" class="level2">
<h2 class="anchored" data-anchor-id="timing-experiments">Timing Experiments:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>pystr <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="st">import os</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="st">os.environ['OPENBLAS_NUM_THREADS'] = '</span><span class="sc">{n_cpu}</span><span class="st">'</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="st"># os.environ</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="st">def return_fun(this_np):</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="st">    n_trix = </span><span class="sc">{n_trix}</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="st">    X = this_np.random.randn(n_trix,n_trix)</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="st">    def fun():</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="st">        for i in range(80):</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a><span class="st">            s = X.dot(X)</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="st">    return fun</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="st">import numpy as np</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="st">fun = return_fun(np)</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a><span class="st">fun()</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a><span class="co"># import os</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="co"># # os.environ["OMP_NUM_THREADS"] = "4" # export OMP_NUM_THREADS=4</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a><span class="co"># os.environ["OPENBLAS_NUM_THREADS"] = "1" # export OPENBLAS_NUM_THREADS=4 </span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # os.environ["MKL_NUM_THREADS"] = "4" # export MKL_NUM_THREADS=6</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a><span class="co"># # os.environ["VECLIB_MAXIMUM_THREADS"] = "4" # export VECLIB_MAXIMUM_THREADS=4</span></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co"># # os.environ["NUMEXPR_NUM_THREADS"] = "4" # export NUMEXPR_NUM_THREADS=6</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(n_cpu, n_trix):</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> subprocess</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    proc <span class="op">=</span> subprocess.run(<span class="st">"python -c </span><span class="ch">\"</span><span class="st">"</span> <span class="op">+</span> pystr.<span class="bu">format</span>(n_cpu<span class="op">=</span>n_cpu, n_trix<span class="op">=</span>n_trix) <span class="op">+</span> <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>, shell<span class="op">=</span><span class="va">True</span>, check<span class="op">=</span><span class="va">False</span>, capture_output<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(proc.stdout.decode('utf-8'))</span></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(proc.stderr.decode('utf-8'))</span></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>n_trix <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">10</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">1</span>]:</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(i)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10
2.74 s ± 131 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
5
2.77 s ± 132 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
2
2.74 s ± 132 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
1
4.87 s ± 49.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</code></pre>
</div>
</div>
</section>
</section>
<section id="schedulers" class="level1">
<h1>Schedulers</h1>
<section id="slurm-submitit-tricks" class="level2">
<h2 class="anchored" data-anchor-id="slurm-submitit-tricks">Slurm &amp; Submitit Tricks</h2>
<p>‘job_dt’ contains dictionary with SlurmJob() objects from the package submitit. How to make these I might specify later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, job <span class="kw">in</span> job_dt.items():</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    job.cancel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cancel ALL submitit jobs!:</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span>  <span class="op">!</span>que</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>stringio <span class="op">=</span> StringIO(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(string))</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>que_df <span class="op">=</span> pd.read_table(stringio, delim_whitespace<span class="op">=</span><span class="va">True</span>)<span class="op">;</span> que_df</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, jobid <span class="kw">in</span> que_df.JOBID[que_df.NAME <span class="op">==</span> <span class="st">'submitit'</span>].iteritems():</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    stop <span class="co"># raise error to prevent effects of sloppy copy pasting.</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>scancel {jobid}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use printouts from job_dt to reinstate the job_dt and continue analysis:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span> <span class="st">"""60080867, 60080868, 60080869, 60080870, 60080871, 60080872, """</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>log_folder <span class="op">=</span> <span class="st">"/home/mennow/dsmwpred/mennow/log_test/%j"</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>eval_job_dt <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, job_id <span class="kw">in</span> <span class="bu">enumerate</span>(string.split(<span class="st">', '</span>)):</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> job_id <span class="op">!=</span> <span class="st">''</span>: eval_job_dt[i] <span class="op">=</span> submitit.SlurmJob(job_id<span class="op">=</span>job_id, folder<span class="op">=</span>log_folder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>string<span class="op">=</span><span class="st">'''{0: SlurmJob&lt;job_id=55037710, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="st"> 1: SlurmJob&lt;job_id=55037711, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="st"> 2: SlurmJob&lt;job_id=55037712, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="st"> 3: SlurmJob&lt;job_id=55037713, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="st"> 4: SlurmJob&lt;job_id=55037714, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="st"> 5: SlurmJob&lt;job_id=55037715, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="st"> 6: SlurmJob&lt;job_id=55037716, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="st"> 7: SlurmJob&lt;job_id=55037717, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="st"> 8: SlurmJob&lt;job_id=55037718, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="st"> 9: SlurmJob&lt;job_id=55037719, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="st"> 10: SlurmJob&lt;job_id=55037720, task_id=0, state="COMPLETED"&gt;,</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="st"> 11: SlurmJob&lt;job_id=55037721, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="st"> 12: SlurmJob&lt;job_id=55037722, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="st"> 13: SlurmJob&lt;job_id=55037723, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="st"> 14: SlurmJob&lt;job_id=55037724, task_id=0, state="RUNNING"&gt;,</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="st"> 15: SlurmJob&lt;job_id=55037725, task_id=0, state="RUNNING"&gt;}'''</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>folder <span class="op">=</span> <span class="st">"/home/mennow/dsmwpred/mennow/log_test/%j"</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>job_dt <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, elem <span class="kw">in</span> <span class="bu">enumerate</span>(string.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)):</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="st">'job_id='</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>    stop <span class="op">=</span> <span class="st">', task_id='</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>    job_id <span class="op">=</span> elem[elem.find(start)<span class="op">+</span><span class="bu">len</span>(start):elem.find(stop)]</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    job_dt[i] <span class="op">=</span> submitit.SlurmJob(job_id<span class="op">=</span>job_id, folder<span class="op">=</span>folder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean out everything older then 9 days modded. Careful with this!</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>find .<span class="op">/</span>log_test<span class="op">/*</span> <span class="op">-</span><span class="bu">type</span> d <span class="op">-</span>ctime <span class="op">+</span><span class="dv">9</span> <span class="op">-</span><span class="bu">exec</span> rm <span class="op">-</span>rf {} \<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span> <span class="op">!</span>squeue <span class="op">-</span>t pd</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co"># string = !squeue -t r # For RUNNING ones.</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(string)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(StringIO(string), delim_whitespace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">'USER'</span>).count().sort_values(by<span class="op">=</span><span class="st">'JOBID'</span>).iloc[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="co"># If you really want all: this cell is a little buggy...</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span> <span class="op">!</span>squeue <span class="op">-</span>u mennow</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(string)<span class="op">--</span><span class="bu">format</span><span class="op">=</span><span class="st">"%all"</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(StringIO(string), delim_whitespace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Seeing some prints:</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>[<span class="bu">print</span>(<span class="ss">f'---&gt; i=</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> &lt;---</span><span class="ch">\n</span><span class="ss">'</span>, job_dt[i].stdout()[<span class="op">-</span><span class="dv">100</span>:]) <span class="cf">for</span> i <span class="kw">in</span> np.sort(np.random.randint(<span class="dv">0</span>,<span class="bu">len</span>(job_dt), <span class="dv">4</span>)) <span class="cf">if</span> job_dt[i].stdout() <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>]</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a><span class="co"># See a unique count of all the Slurm states:</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame([elem.state <span class="cf">for</span> elem <span class="kw">in</span> eval_job_dt.values()])</span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>df[<span class="dv">1</span>] <span class="op">=</span> <span class="fl">1.</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="dv">0</span>).count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Resubmission of Jobs:</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>resub_lst <span class="op">=</span> []</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, job <span class="kw">in</span> eval_job_dt.items():x</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> job.state <span class="op">==</span> <span class="st">'FAILED'</span>:</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>        new_job <span class="op">=</span> executor.submit(job.submission().function)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>        eval_job_dt[key] <span class="op">=</span> new_job</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>        resub_lst.append(key)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(key, job)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'DONE'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unpack job subs:</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get those configs back:</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>job.submission().function.__globals__[<span class="st">'cfg_dt'</span>]</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co"># It seems that the source can actually get lost</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>inspect.getsource(job.submission().function) <span class="co"># DOES NOT WORK after some time.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="jupyter-things" class="level1">
<h1>Jupyter things</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1</code></pre>
</div>
</div>
<section id="javascript-html-formatting" class="level2">
<h2 class="anchored" data-anchor-id="javascript-html-formatting">Javascript, HTML, formatting</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># useful for getting dataframes on the same row, will mess up the rest of the nb (not cell specific)</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="co"># display(HTML(f"&lt;style&gt;.cell-{durr} .output {{flex-direction: row;}}&lt;/style&gt;"))</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="co"># display(HTML('&lt;style&gt;.output {flex-direction: row;}&lt;/style&gt;'))</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>display(HTML(<span class="st">'&lt;style&gt;.output {flex-direction: column;}&lt;/style&gt;'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>.output {flex-direction: column;}</style>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the cell ID</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cell_id():</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    shell <span class="op">=</span> get_ipython()</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shell:</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shell.execution_count</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>cell_id <span class="op">=</span> get_cell_id()</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cell ID:"</span>, cell_id)</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print(_i78)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_i,_ii,_iii)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>shell <span class="op">=</span> get_ipython()</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>r<span class="op">=</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> output_area <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co">// find my cell element</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cell_element <span class="op">=</span> output_area<span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">parents</span>(<span class="st">'.cell'</span>)<span class="op">;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co">// which cell is it?</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cell_idx <span class="op">=</span> Jupyter<span class="op">.</span><span class="at">notebook</span><span class="op">.</span><span class="fu">get_cell_elements</span>()<span class="op">.</span><span class="fu">index</span>(cell_element)<span class="op">;</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="co">// get the cell object</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cell <span class="op">=</span> Jupyter<span class="op">.</span><span class="at">notebook</span><span class="op">.</span><span class="fu">get_cell</span>(cell_idx)<span class="op">;</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="co">// IPython.notebook.kernel.execute(`myvar = '${encodeURI(cell)}'`);</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>IPython<span class="op">.</span><span class="at">notebook</span><span class="op">.</span><span class="at">kernel</span><span class="op">.</span><span class="fu">execute</span>(<span class="vs">`myvar = '</span><span class="sc">${</span>cell_idx<span class="sc">}</span><span class="vs">'`</span>)<span class="op">;</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"jkhergkjhkjge mennow message"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>myvar<span class="op">=</span><span class="st">'empty'</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>string <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="st">var output_area = this;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="st">// find my cell element</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="st">var cell_element = output_area.element.parents('.cell');</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="st">// which cell is it?</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="st">var cell_idx = Jupyter.notebook.get_cell_elements().index(cell_element);</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="st">// get the cell object</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="st">var cell = Jupyter.notebook.get_cell(cell_idx);</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="st">// IPython.notebook.kernel.execute(`myvar = '${encodeURI(cell)}'`);</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="st">IPython.notebook.kernel.execute(`myvar = '$</span><span class="sc">{cell_idx}</span><span class="st">'`);</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>display(Javascript(string))</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(myvar) <span class="co"># Problem with this thing is that it is one behind. </span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to wait for the cell to execute. Prob. some GIL issues thing.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/javascript">

var output_area = this;
// find my cell element
var cell_element = output_area.element.parents('.cell');
// which cell is it?
var cell_idx = Jupyter.notebook.get_cell_elements().index(cell_element);
// get the cell object
var cell = Jupyter.notebook.get_cell(cell_idx);
// IPython.notebook.kernel.execute(`myvar = '${encodeURI(cell)}'`);
IPython.notebook.kernel.execute(`myvar = '${cell_idx}'`);

</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>empty</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now it does contain the cell location:</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(myvar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>179</code></pre>
</div>
</div>
<div class="sourceCode" id="cb117"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>Use HTML commands for images inorder to be able to resize them!</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div&gt;&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">"attachment:image.png"</span> <span class="er">alt</span><span class="ot">=</span><span class="st">"bbla ballablal"</span> <span class="er">style</span><span class="ot">=</span><span class="st">"max-width: 20%"</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>This also works:</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">style</span><span class="ot">=</span><span class="st">"width:25%;"</span><span class="kw">&gt;</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>![image.png](attachment:image.png)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/div&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
Use HTML commands for images inorder to be able to resize them!
<div>
<img src="attachment:image.png" alt="bbla ballablal" style="max-width: 20%">
</div>
This also works:
<div style="width:25%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="attachment:image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">image.png</figcaption>
</figure>
</div>
</div>
<div class="sourceCode" id="cb118"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">class</span><span class="ot">=</span><span class="st">'lead'</span><span class="kw">&gt;</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>This is a nice looking little bigger text.</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/p&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p class="lead">
This is a nice looking little bigger text.
</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">#not sure what you can do with this</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">'''</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="st">div.warn {    </span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="st">    background-color: #fcf2f2;</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="st">    border-color: #dFb5b4;</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="st">    border-left: 5px solid #dfb5b4;</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="st">    padding: 0.5em;</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
div.warn {    
    background-color: #fcf2f2;
    border-color: #dFb5b4;
    border-left: 5px solid #dfb5b4;
    padding: 0.5em;
    }
</style>
</div>
</div>
</section>
<section id="create-your-own-magic" class="level2">
<h2 class="anchored" data-anchor-id="create-your-own-magic">Create your own magic!</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.magic <span class="im">import</span> register_cell_magic</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="at">@register_cell_magic</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_and_run(line, cell):</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    argz <span class="op">=</span> line.split()</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> argz[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    mode <span class="op">=</span> <span class="st">'w'</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(argz) <span class="op">==</span> <span class="dv">2</span> <span class="kw">and</span> argz[<span class="dv">0</span>] <span class="op">==</span> <span class="st">'-a'</span>:</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">'a'</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="bu">file</span>, mode) <span class="im">as</span> f:</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>        f.write(cell)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>    get_ipython().run_cell(cell)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="development" class="level1">
<h1>Development</h1>
<section id="tricks" class="level2">
<h2 class="anchored" data-anchor-id="tricks">Tricks</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The thing to do:</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run this line if you want to get some help infos:</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>??implot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># blr.alpha_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reimporting things (not sure it works like desired..) # debuggin needed</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span>  </span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># import mjwt</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co"># mjwt=reload(mjwt)</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mjwt.utils</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>mjwt.utils<span class="op">=</span><span class="bu">reload</span>(mjwt.utils)</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mjwt.utils <span class="im">import</span> printfun</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># self</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>self=BayesianRidge()
dt['some_fun'].__name__=funkynamed_fun
{'__abstractmethods__': frozenset(), '__annotations__': {'_parameter_constraints': &lt;class 'dict'&gt;}, '__class__': &lt;class 'sklearn.linear_model._bayes.B  ... etc.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># _dh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get previous outputs or inputs:</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_)<span class="op">;</span> <span class="co"># or [__,___]</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(In[<span class="op">-</span><span class="dv">1</span>]) <span class="co"># Or inputs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1
# Get previous outputs or inputs:
print(_); # or [__,___]
print(In[-1]) # Or inputs</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun(cut):</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">&gt;</span>cut:</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'I break-ed'</span>)<span class="op">;</span> <span class="cf">break</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="bu">print</span>(<span class="st">'I did not break'</span>) <span class="co">#convergence</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>fun(<span class="dv">2</span>)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>fun(<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>I break-ed
I did not break</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># comment - durr now</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> notebook:</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(In[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># comment - durr now
if notebook:
    print(In[-1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the cell ID</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cell_id():</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    shell <span class="op">=</span> get_ipython()</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shell:</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shell.execution_count</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>cell_id <span class="op">=</span> get_cell_id()</span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cell ID:"</span>, cell_id)</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print(_i78)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cell ID: 136</code></pre>
</div>
</div>
</section>
<section id="under-the-hoodys" class="level2">
<h2 class="anchored" data-anchor-id="under-the-hoodys">Under the hoodys:</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Leet hierarchy surfing:</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> funkynamed_fun():</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'text'</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> {<span class="st">'some_fun'</span>:funkynamed_fun}</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> BayesianRidge()</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>method <span class="op">=</span> blr.fit</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="co"># vars() like stuff</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="va">self</span> <span class="op">=</span> method.__self__</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"{self:=}")</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="op">=</span><span class="sc">:}</span><span class="ss">"</span>)</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="co"># get the name of a function as variable</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>dt[<span class="st">'some_fun'</span>]<span class="sc">.</span><span class="va">__name__</span><span class="op">=</span><span class="sc">:}</span><span class="ss">"</span>)</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>obj_dt <span class="op">=</span> {field:<span class="bu">getattr</span>(obj,field) <span class="cf">for</span> field <span class="kw">in</span> <span class="bu">dir</span>(obj)}</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">repr</span>(obj_dt)[:<span class="dv">150</span>], <span class="st">' ... etc.'</span>)<span class="op">;</span><span class="dv">1</span> <span class="co"># print obj_dt</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>self=BayesianRidge()
dt['some_fun'].__name__=funkynamed_fun
{'__abstractmethods__': frozenset(), '__annotations__': {'_parameter_constraints': &lt;class 'dict'&gt;}, '__class__': &lt;class 'sklearn.linear_model._bayes.B  ... etc.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Magic!! vars()</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(implot.__code__.co_varnames)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(inspect.getfullargspec(implot))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('cmap', 'midpoint', 'title', 'figsize', 'f', 'ncols', 'nrows', 'vmin', 'vmax', 'show', 'interpolation', 'args', 'kwargs', 'frame', 'code', 'arr', 'admin', 'commas', 'num', 'titles_dt', 'aspect', 'suffix_title', 'height', 'cnt', 'fig', 'axes', 'nn', 'ax', 'vals', 'mid', 'delta', 'im')
FullArgSpec(args=[], varargs='args', varkw='kwargs', defaults=None, kwonlyargs=['cmap', 'midpoint', 'title', 'figsize', 'f', 'ncols', 'nrows', 'vmin', 'vmax', 'show', 'interpolation'], kwonlydefaults={'cmap': 'seismic', 'midpoint': &lt;function median&gt;, 'title': None, 'figsize': None, 'f': 1.4, 'ncols': 1, 'nrows': 1, 'vmin': None, 'vmax': None, 'show': True, 'interpolation': 'none'}, annotations={})</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> linear_model</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>display(inspect.getmro(linear_model.BayesianRidge.__class__))</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(inspect.getmro(linear_model.BayesianRidge.__class__)) <span class="co"># get class inheritance stuffies</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="co"># assert LinkageData in linkdata.__class__.__mro__ # moar mro things</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(abc.ABCMeta, type, object)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(&lt;class 'abc.ABCMeta'&gt;, &lt;class 'type'&gt;, &lt;class 'object'&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">dir</span>(__builtins__))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['ArithmeticError', 'AssertionError', 'AttributeError', 'BaseException', 'BaseExceptionGroup', 'BlockingIOError', 'BrokenPipeError', 'BufferError', 'BytesWarning', 'ChildProcessError', 'ConnectionAbortedError', 'ConnectionError', 'ConnectionRefusedError', 'ConnectionResetError', 'DeprecationWarning', 'EOFError', 'Ellipsis', 'EncodingWarning', 'EnvironmentError', 'Exception', 'ExceptionGroup', 'False', 'FileExistsError', 'FileNotFoundError', 'FloatingPointError', 'FutureWarning', 'GeneratorExit', 'IOError', 'ImportError', 'ImportWarning', 'IndentationError', 'IndexError', 'InterruptedError', 'IsADirectoryError', 'KeyError', 'KeyboardInterrupt', 'LookupError', 'MemoryError', 'ModuleNotFoundError', 'NameError', 'None', 'NotADirectoryError', 'NotImplemented', 'NotImplementedError', 'OSError', 'OverflowError', 'PendingDeprecationWarning', 'PermissionError', 'ProcessLookupError', 'RecursionError', 'ReferenceError', 'ResourceWarning', 'RuntimeError', 'RuntimeWarning', 'StopAsyncIteration', 'StopIteration', 'SyntaxError', 'SyntaxWarning', 'SystemError', 'SystemExit', 'TabError', 'TimeoutError', 'True', 'TypeError', 'UnboundLocalError', 'UnicodeDecodeError', 'UnicodeEncodeError', 'UnicodeError', 'UnicodeTranslateError', 'UnicodeWarning', 'UserWarning', 'ValueError', 'Warning', 'ZeroDivisionError', '__IPYTHON__', '__build_class__', '__debug__', '__doc__', '__import__', '__loader__', '__name__', '__package__', '__pybind11_internals_v4_gcc_libstdcpp_cxxabi1014__', '__spec__', 'abs', 'aiter', 'all', 'anext', 'any', 'ascii', 'bin', 'bool', 'breakpoint', 'bytearray', 'bytes', 'callable', 'chr', 'classmethod', 'compile', 'complex', 'copyright', 'credits', 'delattr', 'dict', 'dir', 'display', 'divmod', 'enumerate', 'eval', 'exec', 'execfile', 'filter', 'float', 'format', 'frozenset', 'get_ipython', 'getattr', 'globals', 'hasattr', 'hash', 'help', 'hex', 'id', 'input', 'int', 'isinstance', 'issubclass', 'iter', 'len', 'license', 'list', 'locals', 'map', 'max', 'memoryview', 'min', 'next', 'object', 'oct', 'open', 'ord', 'pow', 'print', 'property', 'range', 'repr', 'reversed', 'round', 'runfile', 'set', 'setattr', 'slice', 'sorted', 'staticmethod', 'str', 'sum', 'super', 'tuple', 'type', 'vars', 'zip']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> Path(inspect.getsourcefile(sizegb)).read_text()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="argparse" class="level2">
<h2 class="anchored" data-anchor-id="argparse">argparse</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-c</span> <span class="st">"""</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="st">import sys</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="st">from argparse import ArgumentParser</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="st">parser = ArgumentParser()</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="st">#parser.add_argument('-c', '--call', type=str)</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="st">parser.add_argument('-b','--ball', type=int, default=42, help='this is ball')</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="st">parser.add_argument('-a','--arg', type=str, default='defastr', help='this is the a') #, action='store')</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="st">#parser.add_argument('-a', name='valstr')</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="st">#parser.add_argument('-a','--arg', name='valstr', action='stoor')</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a><span class="st">parser.add_argument('-c', type=str)</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a><span class="st">parser.add_argument('--xpname', type=str, required=True)</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="st">print('parser:\n', parser)</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="st">args = parser.parse_args()</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a><span class="st">print('args: \n',args)</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a><span class="st">print(args.xpname)</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a><span class="st">print(sys.argv)</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a><span class="st">print('-- did all the red stuff in the cell above --')    </span></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span> <span class="at">--xpname</span> blablkabkl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parser:
 ArgumentParser(prog='-c', usage=None, description=None, formatter_class=&lt;class 'argparse.HelpFormatter'&gt;, conflict_handler='error', add_help=True)
args: 
 Namespace(ball=42, arg='defastr', c=None, xpname='blablkabkl')
blablkabkl
['-c', '--xpname', 'blablkabkl']
-- did all the red stuff in the cell above --</code></pre>
</div>
</div>
</section>
<section id="bash" class="level2">
<h2 class="anchored" data-anchor-id="bash">Bash</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How to send commands to commandline and get sensical strings back:</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>info <span class="op">=</span> subprocess.check_output(<span class="st">'ls -atlr'</span>, shell<span class="op">=</span><span class="va">True</span>).decode(<span class="st">"utf-8"</span>) <span class="co"># decode to go from bytestring to string</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">str</span>(info))</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="co"># not sure why this would be preferable over: !do things {insert_string_from_python}; do more things</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>total 5224
-rw-r--r--  1 jovyan users   55320 Oct  9  2020 coef_df.h5
-rw-r--r--  1 jovyan users     290 Jun  9 12:50 _quarto.yml
-rw-rw-r--  1 jovyan users    2217 Jun 14 13:51 index.ipynb
-rw-rw-r--  1 jovyan users   17248 Jun 15 12:41 00_utils.ipynb
drwxr-xr-x  8 jovyan users     256 Jun 15 15:00 _archiv
drwxr-xr-x  6 jovyan users     192 Jun 15 15:01 .ipynb_checkpoints
-rw-rw-r--  1 jovyan users     620 Jun 15 16:11 styles.css
-rw-r--r--  1 jovyan users     276 Jun 15 18:02 nbdev.yml
-rw-r--r--  1 jovyan users     106 Jun 15 18:02 sidebar.yml
drwxr-xr-x 20 jovyan users     640 Jun 15 18:03 ..
-rw-r--r--  1 jovyan users    6148 Jun 15 18:17 .DS_Store
-rw-r--r--  1 jovyan users 5008780 Jun 16 18:02 ipynb_snippets.ipynb
drwxr-xr-x 13 jovyan users     416 Jun 16 18:02 .
</code></pre>
</div>
</div>
</section>
<section id="decoration" class="level2">
<h2 class="anchored" data-anchor-id="decoration">Decoration</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Methods that overwrite the getting and setting syntax</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> C(<span class="bu">object</span>):</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._x <span class="op">=</span> <span class="va">None</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> x(<span class="va">self</span>):</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""I'm the 'x' property."""</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"getter of x called"</span>)</span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._x</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@x.setter</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> x(<span class="va">self</span>, value):</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"setter of x called"</span>)</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._x <span class="op">=</span> value</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@x.deleter</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> x(<span class="va">self</span>):</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"deleter of x called"</span>)</span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> <span class="va">self</span>._x</span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> C()</span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>c.x <span class="op">=</span> <span class="st">'foo'</span>  <span class="co"># setter called</span></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>foo <span class="op">=</span> c.x    <span class="co"># getter called</span></span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> c.x      <span class="co"># deleter called</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>setter of x called
getter of x called
deleter of x called</code></pre>
</div>
</div>
</section>
<section id="package-creation-stuff" class="level2">
<h2 class="anchored" data-anchor-id="package-creation-stuff">Package creation stuff</h2>
<ul>
<li>A template: https://github.com/RobertoPrevato/PythonTemplate</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a requirements.txt automatically</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pipreqs <span class="op">~/</span>proj<span class="op">/</span>mjwt<span class="op">/</span> <span class="co"># --force</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: Import named "scipy" not found locally. Trying to resolve it at the PyPI server.
WARNING: Import named "scipy" was resolved to "scipy:1.10.1" package (https://pypi.org/project/scipy/).
Please, verify manually the final list of requirements.txt to avoid possible dependency confusions.
INFO: Successfully saved requirements file in /home/jovyan/proj/mjwt/requirements.txt</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install pipreqs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>


</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>